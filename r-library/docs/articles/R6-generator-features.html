<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R6 Generator Maven Plugin: Key features • testRapi</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="R6 Generator Maven Plugin: Key features">
<meta property="og:description" content="testRapi">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">testRapi</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/R6-generator-datatypes.html">R6 Generator Maven Plugin: Datatype conversion</a>
    </li>
    <li>
      <a href="../articles/R6-generator-features.html">R6 Generator Maven Plugin: Key features</a>
    </li>
    <li>
      <a href="../articles/R6-generator-intro.html">R6 Generator Maven Plugin: Bridging Java and R6 for Package Development</a>
    </li>
    <li>
      <a href="../articles/R6-generator-maven-config.html">R6 Generator Maven Plugin: Metadata and Maven configuration</a>
    </li>
    <li>
      <a href="../articles/R6-generator-runtime.html">R6 Generator Runtime: Using R Datatypes in Java</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="R6-generator-features_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>R6 Generator Maven Plugin: Key features</h1>
                        <h4 class="author">Rob Challen</h4>
            
            <h4 class="date">19/10/2020</h4>
      
      
      <div class="hidden name"><code>R6-generator-features.Rmd</code></div>

    </div>

    
    
<div class="watermark">
DRAFT
</div>
<div id="features" class="section level2">
<h2 class="hasAnchor">
<a href="#features" class="anchor"></a>Features</h2>
<p>The <code>FeatureTest</code> Java class is designed to showcase the main aspects of the R6 Generator Maven Plugin, and serves as a quick guide to Java programmers wishing to use the plugin. The source of the <code>FeatureTest</code> class is shown below, where the use of the Java annotations <code>@RClass</code> and <code>@RMethod</code> tag a class, and specific methods in that class for use in R. The code structure, parameters and return values or the tagged classes and methods are used to create an equivalent R6 class structure in an R library. In general Javadoc comments and tags are used to document the library, and where there are no applicable tags specific fields in the <code>@RClass</code> and <code>@RMethod</code> annotations can been used to specify needed imports, suggested R package dependencies and provide specific example code if needed.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb1-1"><a href="#cb1-1"></a><span class="co">/**</span></span>
<span id="cb1-2"><a href="#cb1-2"></a> <span class="co">*</span> A test of the R6 generator templating</span>
<span id="cb1-3"><a href="#cb1-3"></a> <span class="co">*</span> </span>
<span id="cb1-4"><a href="#cb1-4"></a> <span class="co">*</span> The feature test should allow mathjax in javadoc</span>
<span id="cb1-5"><a href="#cb1-5"></a> <span class="co">*</span> </span>
<span id="cb1-6"><a href="#cb1-6"></a> <span class="co">*</span> <span class="co">$$</span>e <span class="co">=</span> mc<span class="co">^2$$</span></span>
<span id="cb1-7"><a href="#cb1-7"></a> <span class="co">*</span> </span>
<span id="cb1-8"><a href="#cb1-8"></a> <span class="co">*</span> </span>
<span id="cb1-9"><a href="#cb1-9"></a> <span class="co">*</span> this is a details comment </span>
<span id="cb1-10"><a href="#cb1-10"></a> <span class="co">* </span><span class="an">@author </span>given family email<span class="co">@</span>example<span class="co">.</span>com ORCIDID</span>
<span id="cb1-11"><a href="#cb1-11"></a> <span class="co">*</span> </span>
<span id="cb1-12"><a href="#cb1-12"></a> <span class="co">*/</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="at">@RClass</span>(</span>
<span id="cb1-14"><a href="#cb1-14"></a>        imports = {<span class="st">"ggplot2"</span>,<span class="st">"dplyr"</span>,<span class="st">"tibble"</span>},</span>
<span id="cb1-15"><a href="#cb1-15"></a>        suggests = {<span class="st">"roxygen2"</span>,<span class="st">"devtools"</span>,<span class="st">"here"</span>}</span>
<span id="cb1-16"><a href="#cb1-16"></a>        )</span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="kw">public</span> <span class="kw">class</span> FeatureTest {</span>
<span id="cb1-18"><a href="#cb1-18"></a></span>
<span id="cb1-19"><a href="#cb1-19"></a>    <span class="bu">String</span> message;</span>
<span id="cb1-20"><a href="#cb1-20"></a>    <span class="dt">static</span> <span class="bu">Logger</span> log = LoggerFactory.<span class="fu">getLogger</span>(FeatureTest.<span class="fu">class</span>);</span>
<span id="cb1-21"><a href="#cb1-21"></a>    </span>
<span id="cb1-22"><a href="#cb1-22"></a>    <span class="co">/**</span></span>
<span id="cb1-23"><a href="#cb1-23"></a>     <span class="co">*</span> A maximum of one constructor of any signature can be used<span class="co">. </span><span class="kw">&lt;br&gt;</span></span>
<span id="cb1-24"><a href="#cb1-24"></a>     <span class="co">*</span> </span>
<span id="cb1-25"><a href="#cb1-25"></a>     <span class="co">*</span> If different constructors are needed then they may be used but not </span>
<span id="cb1-26"><a href="#cb1-26"></a>     <span class="co">*</span> included in the R Api <span class="co">(</span>i<span class="co">.</span>e<span class="co">.</span> not annotated with <span class="co">@</span>RMethod<span class="co">.)</span> <span class="kw">&lt;br&gt;</span></span>
<span id="cb1-27"><a href="#cb1-27"></a>     <span class="co">*</span> </span>
<span id="cb1-28"><a href="#cb1-28"></a>     <span class="co">*</span> Static factory methods can be used instead<span class="co">.</span></span>
<span id="cb1-29"><a href="#cb1-29"></a>     <span class="co">*</span> <span class="an">@param logMessage </span><span class="co">-</span> a message which will be logged</span>
<span id="cb1-30"><a href="#cb1-30"></a>     <span class="co">*/</span></span>
<span id="cb1-31"><a href="#cb1-31"></a>    <span class="at">@RMethod</span>(examples = {</span>
<span id="cb1-32"><a href="#cb1-32"></a>            <span class="st">"minExample = J$FeatureTest$new('Hello from Java constructor!')"</span>,</span>
<span id="cb1-33"><a href="#cb1-33"></a>        })</span>
<span id="cb1-34"><a href="#cb1-34"></a>    <span class="kw">public</span> <span class="fu">FeatureTest</span>(<span class="bu">String</span> logMessage) {</span>
<span id="cb1-35"><a href="#cb1-35"></a>        log.<span class="fu">info</span>(logMessage);</span>
<span id="cb1-36"><a href="#cb1-36"></a>        <span class="kw">this</span>.<span class="fu">message</span> = logMessage;</span>
<span id="cb1-37"><a href="#cb1-37"></a>    }</span>
<span id="cb1-38"><a href="#cb1-38"></a>    </span>
<span id="cb1-39"><a href="#cb1-39"></a>...</span>
<span id="cb1-40"><a href="#cb1-40"></a>    </span>
<span id="cb1-41"><a href="#cb1-41"></a>    <span class="at">@RFinalize</span></span>
<span id="cb1-42"><a href="#cb1-42"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">close</span>() {</span>
<span id="cb1-43"><a href="#cb1-43"></a>        log.<span class="fu">info</span>(<span class="st">"The FeatureTest finalizer is called when the R6 object goes out of scope"</span>);</span>
<span id="cb1-44"><a href="#cb1-44"></a>        <span class="kw">throw</span> <span class="kw">new</span> <span class="bu">RuntimeException</span>(<span class="st">"Errors from the finalizer are ignored"</span>);</span>
<span id="cb1-45"><a href="#cb1-45"></a>    }</span>
<span id="cb1-46"><a href="#cb1-46"></a>}</span></code></pre></div>
<p>The packaging of this class into an R library is described <a href="./R6-generator-intro">elsewhere</a>. The package name (in this case <code>testRapi</code>), the directory of the library (in this example <code>~/Git/r6-generator-maven-plugin-test/r-library/</code>) and other metadata such as author and license details are defined in the Maven plugin configuration (in a file named <code>pom.xml</code>). This configuration is described in detail <a href="./R6-generator-maven-config">elsewhere</a>. For the purposes of this we assume the Java code has been compiled, generating the <code>testRapi</code> R package which is ready for installation.</p>
</div>
<div id="installation-and-instantiation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation-and-instantiation" class="anchor"></a>Installation and instantiation</h2>
<p>The generated R package can be installed into R in more or less the same way as any other R library, depending on how it is deployed. Typical scenarios would be pushing the whole Java project to Github and installing to R from Github using <code><a href="https://devtools.r-lib.org/reference/remote-reexports.html">devtools::install_github()</a></code>, installing directly from the local filesystem, with <code><a href="https://devtools.r-lib.org/reference/install.html">devtools::install()</a></code>, or submitting the R library sub-directory as a project to CRAN and installing from there, using <code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages()</a></code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="co"># not run</span>
<span class="co"># remove installed versions</span>
<span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/detach.html">detach</a></span><span class="op">(</span><span class="st">"package:testRapi"</span>, unload <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/remove.packages.html">remove.packages</a></span><span class="op">(</span><span class="st">"testRapi"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>Restarting R maybe also required if there was a running java VM.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="co"># locally compiled</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/install.html">install</a></span><span class="op">(</span><span class="st">"~/Git/r6-generator-maven-plugin-test/r-library/"</span>, upgrade <span class="op">=</span> <span class="st">"never"</span><span class="op">)</span>
<span class="co"># pushed to github</span>
<span class="co"># devtools::install_github("terminological/r6-generator-maven-plugin-test", subdir = "r-library", upgrade = "never")</span>
<span class="co"># submitted to CRAN</span>
<span class="co"># install.packages("testRapi")</span>
<span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"vignettes/codeSnip.R"</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>The R6 api to the Java classes requires a running instance of the Java Virtual Machine and JNI bridge provided by <em>rJava</em>. It also requires Java classpath dependencies to be loaded and application logging to be initialised. This is all managed by a specific generated R6 class called <code>JavaApi</code> and creating a singleton instance of this is the first step to using the library in R. In these examples the singleton instance <code>J</code> is referred to as the “root” of the api, as all the functions of the API stem from it.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="va">J</span> <span class="op">=</span> <span class="fu">testRapi</span><span class="fu">::</span><span class="va"><a href="../reference/JavaApi.html">JavaApi</a></span><span class="op">$</span><span class="fu">get</span><span class="op">(</span>logLevel <span class="op">=</span> <span class="st">"WARN"</span><span class="op">)</span></pre></div>
<pre><code>## Initialising A test library</code></pre>
<pre><code>## Version: 0.2.0.9000</code></pre>
<pre><code>## Generated: 2022-05-18T23:19:53.137054</code></pre>
<pre><code>## Adding to classpath: /tmp/RtmpuhY0Dk/temp_libpath52f062487da0/testRapi/java/r6-generator-maven-plugin-test-master-SNAPSHOT-jar-with-dependencies.jar</code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="va">J</span><span class="op">$</span><span class="fu">changeLogLevel</span><span class="op">(</span><span class="st">"DEBUG"</span><span class="op">)</span>
<span class="va">J</span><span class="op">$</span><span class="va">.log</span><span class="op">$</span><span class="fu">debug</span><span class="op">(</span><span class="st">"prove the logger is working and outputting debug statements..."</span><span class="op">)</span>
<span class="va">J</span><span class="op">$</span><span class="fu">printMessages</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## 2022-05-18 23:25:05,134 DEBUG testRapi [main] prove the logger is working and outputting debug statements...</code></pre>
<p>Using the <code>FeatureTest</code> class above requires a creating a new instance of the class. This is done through the root of the api as follows, and the <code>FeatureTest</code> constructor simply logs the <code>logMessage</code> parameter’s value.</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="va">feat1</span> <span class="op">=</span> <span class="va">J</span><span class="op">$</span><span class="va">FeatureTest</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>logMessage <span class="op">=</span> <span class="st">"Hello world. Creating a new object"</span><span class="op">)</span></pre></div>
<pre><code>## 2022-05-18 23:25:05,205 INFO uk.co.terminological.rjava.test.FeatureTest [main] Hello world. Creating a new object</code></pre>
</div>
<div id="predictable-data-type-conversion" class="section level2">
<h2 class="hasAnchor">
<a href="#predictable-data-type-conversion" class="anchor"></a>Predictable data type conversion</h2>
<div class="sourceCode" id="cb13"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb13-1"><a href="#cb13-1"></a>    </span>
<span id="cb13-2"><a href="#cb13-2"></a>    <span class="co">/**</span></span>
<span id="cb13-3"><a href="#cb13-3"></a>     <span class="co">*</span> Description of a hello world function</span>
<span id="cb13-4"><a href="#cb13-4"></a>     <span class="co">* </span><span class="an">@return </span>this java method returns a String</span>
<span id="cb13-5"><a href="#cb13-5"></a>     <span class="co">*/</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>    <span class="at">@RMethod</span>(examples = {</span>
<span id="cb13-7"><a href="#cb13-7"></a>            <span class="st">"minExample = J$FeatureTest$new('Hello, R World!')"</span>,</span>
<span id="cb13-8"><a href="#cb13-8"></a>            <span class="st">"minExample$doHelloWorld()"</span></span>
<span id="cb13-9"><a href="#cb13-9"></a>        })</span>
<span id="cb13-10"><a href="#cb13-10"></a>    <span class="kw">public</span> RCharacter <span class="fu">doHelloWorld</span>() {</span>
<span id="cb13-11"><a href="#cb13-11"></a>        <span class="kw">return</span> RConverter.<span class="fu">convert</span>(<span class="st">"Hello world from Java!"</span>);</span>
<span id="cb13-12"><a href="#cb13-12"></a>    }</span>
<span id="cb13-13"><a href="#cb13-13"></a>        </span>
<span id="cb13-14"><a href="#cb13-14"></a>    <span class="co">/**</span></span>
<span id="cb13-15"><a href="#cb13-15"></a>     <span class="co">*</span> The doSum function description <span class="co">=</span> it adds two numerics</span>
<span id="cb13-16"><a href="#cb13-16"></a>     <span class="co">* </span><span class="an">@param a </span>the A parameter<span class="co">,</span> can be NA</span>
<span id="cb13-17"><a href="#cb13-17"></a>     <span class="co">*</span> <span class="an">@param b </span>the B parameter</span>
<span id="cb13-18"><a href="#cb13-18"></a>     <span class="co">*</span> <span class="an">@return </span>A<span class="co">+</span>B of course<span class="co">,</span> NAs in inputs are converted to null in Java<span class="co">.</span> This catches the resulting NPE in java idiom and returns an explicit NA<span class="co">.</span> </span>
<span id="cb13-19"><a href="#cb13-19"></a>     <span class="co">*</span> This only matters if you care about the difference between NA_real_ and NaN in R<span class="co">.</span> </span>
<span id="cb13-20"><a href="#cb13-20"></a>     <span class="co">*/</span></span>
<span id="cb13-21"><a href="#cb13-21"></a>    <span class="at">@RMethod</span></span>
<span id="cb13-22"><a href="#cb13-22"></a>    <span class="kw">public</span> RNumeric <span class="fu">doSum</span>(RNumeric a, RNumeric b) {</span>
<span id="cb13-23"><a href="#cb13-23"></a>        <span class="kw">try</span> {</span>
<span id="cb13-24"><a href="#cb13-24"></a>            <span class="kw">return</span> RConverter.<span class="fu">convert</span>(a.<span class="fu">get</span>()+b.<span class="fu">get</span>());</span>
<span id="cb13-25"><a href="#cb13-25"></a>        } <span class="kw">catch</span> (<span class="bu">NullPointerException</span> e) {</span>
<span id="cb13-26"><a href="#cb13-26"></a>            log.<span class="fu">info</span>(<span class="st">"Java threw a NPE - could have had a NA input?"</span>);</span>
<span id="cb13-27"><a href="#cb13-27"></a>            <span class="kw">return</span> RNumeric.<span class="fu">NA</span>;</span>
<span id="cb13-28"><a href="#cb13-28"></a>        }</span>
<span id="cb13-29"><a href="#cb13-29"></a>    }</span>
<span id="cb13-30"><a href="#cb13-30"></a>    </span>
<span id="cb13-31"><a href="#cb13-31"></a>    </span>
<span id="cb13-32"><a href="#cb13-32"></a>    <span class="co">/**</span></span>
<span id="cb13-33"><a href="#cb13-33"></a>     <span class="co">*</span> Do sum <span class="co">2</span> uses native ints rather than RNumerics</span>
<span id="cb13-34"><a href="#cb13-34"></a>     <span class="co">*</span> It should throw an error if given something that cannot be coerced to an integer<span class="co">. </span></span>
<span id="cb13-35"><a href="#cb13-35"></a>     <span class="co">*</span> This also demonstrated the use of the <span class="co">`@</span>RDefault<span class="co">`</span> annotation</span>
<span id="cb13-36"><a href="#cb13-36"></a>     <span class="co">*</span> <span class="an">@param a </span>the A parameter</span>
<span id="cb13-37"><a href="#cb13-37"></a>     <span class="co">*</span> <span class="an">@param b </span>the B parameter</span>
<span id="cb13-38"><a href="#cb13-38"></a>     <span class="co">*</span> <span class="an">@return </span>A<span class="co">+</span>B of course</span>
<span id="cb13-39"><a href="#cb13-39"></a>     <span class="co">*/</span></span>
<span id="cb13-40"><a href="#cb13-40"></a>    <span class="at">@RMethod</span></span>
<span id="cb13-41"><a href="#cb13-41"></a>    <span class="kw">public</span> <span class="dt">int</span> <span class="fu">doSum2</span>(<span class="dt">int</span> a, <span class="at">@RDefault</span>(rCode = <span class="st">"10"</span>) <span class="dt">int</span> b) {</span>
<span id="cb13-42"><a href="#cb13-42"></a>        <span class="kw">return</span> a+b;</span>
<span id="cb13-43"><a href="#cb13-43"></a>    }</span>
<span id="cb13-44"><a href="#cb13-44"></a>    </span>
<span id="cb13-45"><a href="#cb13-45"></a>    <span class="co">/**</span></span>
<span id="cb13-46"><a href="#cb13-46"></a>     <span class="co">*</span> Static methods are also supported<span class="co">. </span>These are accessed through the</span>
<span id="cb13-47"><a href="#cb13-47"></a>     <span class="co">*</span> root of the R api<span class="co">.</span></span>
<span id="cb13-48"><a href="#cb13-48"></a>     <span class="co">*</span> <span class="an">@param message </span>a message</span>
<span id="cb13-49"><a href="#cb13-49"></a>     <span class="co">*/</span></span>
<span id="cb13-50"><a href="#cb13-50"></a>    <span class="at">@RMethod</span>(examples = {</span>
<span id="cb13-51"><a href="#cb13-51"></a>            <span class="st">"J$FeatureTest$demoStatic('Ola, el mundo')"</span>,</span>
<span id="cb13-52"><a href="#cb13-52"></a>    })</span>
<span id="cb13-53"><a href="#cb13-53"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">demoStatic</span>(<span class="bu">String</span> message) {</span>
<span id="cb13-54"><a href="#cb13-54"></a>        log.<span class="fu">info</span>(message);</span>
<span id="cb13-55"><a href="#cb13-55"></a>    }</span>
<span id="cb13-56"><a href="#cb13-56"></a>    </span></code></pre></div>
<p>The <code>FeatureClass.doHelloWorld()</code> method takes no arguments and returns a value to R. A detailed discussion of R and Java data types is to be found elsewhere but our approach has involved developing a specific set of Java datatypes that have close relationships to the native R datatypes. This enables loss-less round tripping of data from R to Java and back again, but requires the mapping of Java data types to R. This is handled by the <code>uk.co.terminological.rjava.RConverter</code> class which provides a range of datatype transformers, and the <code>uk.co.terminological.rjava.types.*</code> classes which specify Java equivalents to R data types. These are needed as R’s dynamic datatypes contain concepts which are not readily represented in the primitive java datatypes that are transferred across the JNI. Thus some marshaling is required on both sides to ensure translation is 100% accurate, including for example, conversion of R logical vectors containing NA values, to java <code>List&lt;Boolean&gt;</code> via JNI primitive arrays, or support for typed NA values (e.g. <code>NA_int_</code> versus <code>NA_logical_</code>).</p>
<p>The <code>doHelloWorld()</code> function returns a character vector, The <code>doSum()</code> function expects 2 R numeric values and seamlessly handles both datatype coercion and NA values.</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="va">feat1</span><span class="op">$</span><span class="fu">doHelloWorld</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## [1] "Hello world from Java!"</code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">doHelloWorld</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## [1] "character"</code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="va">feat1</span><span class="op">$</span><span class="fu">doSum</span><span class="op">(</span><span class="fl">3L</span>, <span class="fl">4.1</span><span class="op">)</span></pre></div>
<pre><code>## [1] 7.1</code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">doSum</span><span class="op">(</span><span class="fl">3L</span>, <span class="fl">4.1</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## [1] "numeric"</code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit">
<span class="va">feat1</span><span class="op">$</span><span class="fu">doSum</span><span class="op">(</span><span class="fl">3.0</span>, <span class="cn">NA_real_</span><span class="op">)</span></pre></div>
<pre><code>## 2022-05-18 23:25:05,379 INFO uk.co.terminological.rjava.test.FeatureTest [main] Java threw a NPE - could have had a NA input?</code></pre>
<pre><code>## [1] NA</code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">doSum</span><span class="op">(</span><span class="fl">3.0</span>, <span class="cn">NA_real_</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## 2022-05-18 23:25:05,380 INFO uk.co.terminological.rjava.test.FeatureTest [main] Java threw a NPE - could have had a NA input?</code></pre>
<pre><code>## [1] "numeric"</code></pre>
<p>Wrapping and unwrapping every datatype is inconvenient for the Java programmer so some single valued primitive types are supported as parameters and return types of Java functions, particularly <code>int</code>, <code>char</code>, <code>double</code>, <code>boolean</code>, and <code>java.lang.String</code>, but these come with constraints on use, particularly around NA values in R.</p>
<div class="sourceCode" id="cb28"><pre class="downlit">
<span class="va">feat1</span><span class="op">$</span><span class="fu">doSum2</span><span class="op">(</span><span class="fl">3L</span>, <span class="fl">4L</span><span class="op">)</span></pre></div>
<pre><code>## [1] 7</code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">doSum2</span><span class="op">(</span><span class="fl">3L</span>, <span class="fl">4L</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## [1] "integer"</code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit">
<span class="co"># casts inputs to integer</span>
<span class="va">feat1</span><span class="op">$</span><span class="fu">doSum2</span><span class="op">(</span><span class="fl">3.0</span>,<span class="fl">4.0</span><span class="op">)</span></pre></div>
<pre><code>## [1] 7</code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">doSum2</span><span class="op">(</span><span class="fl">3.0</span>,<span class="fl">4.0</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## [1] "integer"</code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit">
<span class="co"># fails as expects an integer</span>
<span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">doSum2</span><span class="op">(</span><span class="fl">3.0</span>,<span class="fl">4.5</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## Error in self$.api$.toJava$int(b) : not an integer</code></pre>
<div class="sourceCode" id="cb38"><pre class="downlit">
<span class="co"># fails as NA values are not supported by primitive types</span>
<span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">doSum2</span><span class="op">(</span><span class="fl">3L</span>,<span class="cn">NA_integer_</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## Error in self$.api$.toJava$int(b) : cant use NA as input to java int</code></pre>
<p>Static java methods are also supported. R6 does not have a concept of static methods, so we use the root of the JavaApi as a place to hold the static methods, which in this case returns nothing (an R NULL is invisibly returned), but logs its input.</p>
<div class="sourceCode" id="cb40"><pre class="downlit">
<span class="va">J</span><span class="op">$</span><span class="va">FeatureTest</span><span class="op">$</span><span class="fu">demoStatic</span><span class="op">(</span><span class="st">"Hello, static world."</span><span class="op">)</span></pre></div>
<pre><code>## 2022-05-18 23:25:05,523 INFO uk.co.terminological.rjava.test.FeatureTest [main] Hello, static world.</code></pre>
</div>
<div id="more-complex-objects" class="section level2">
<h2 class="hasAnchor">
<a href="#more-complex-objects" class="anchor"></a>More complex objects</h2>
<p>The generated API has support for the loss-less bi-directional transfer of a range of R data types into Java and back to R. Extensive tests are available elsewhere but in general support for vectors, dataframes and lists is mostly complete, including factors, but matrices and arrays are not yet implemented. Dataframes with named rows are also not yet supported. Dataframes as well as other objects can be serialised in Java and de-serialised. This serialisation has been done for the ggplot2::diamonds data set, and the resulting de-serialisation shown here. Factor levels and ordering are preserved when the factor is part of a vector or dataframe.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb42-1"><a href="#cb42-1"></a>    </span>
<span id="cb42-2"><a href="#cb42-2"></a>    <span class="co">/**</span></span>
<span id="cb42-3"><a href="#cb42-3"></a>     <span class="co">*</span> Consumes a data frame and logs its length</span>
<span id="cb42-4"><a href="#cb42-4"></a>     <span class="co">* </span><span class="an">@param dataframe </span>a dataframe</span>
<span id="cb42-5"><a href="#cb42-5"></a>     <span class="co">*/</span></span>
<span id="cb42-6"><a href="#cb42-6"></a>    <span class="at">@RMethod</span></span>
<span id="cb42-7"><a href="#cb42-7"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">doSomethingWithDataFrame</span>(RDataframe dataframe) {</span>
<span id="cb42-8"><a href="#cb42-8"></a>        log.<span class="fu">info</span>(<span class="st">"dataframe length: "</span>+dataframe.<span class="fu">nrow</span>());</span>
<span id="cb42-9"><a href="#cb42-9"></a>    }</span>
<span id="cb42-10"><a href="#cb42-10"></a>    </span>
<span id="cb42-11"><a href="#cb42-11"></a>    <span class="co">/**</span></span>
<span id="cb42-12"><a href="#cb42-12"></a>     <span class="co">*</span> Creates a basic dataframe and returns it</span>
<span id="cb42-13"><a href="#cb42-13"></a>     <span class="co">* </span><span class="an">@return </span>a daatframe</span>
<span id="cb42-14"><a href="#cb42-14"></a>     <span class="co">*/</span></span>
<span id="cb42-15"><a href="#cb42-15"></a>    <span class="at">@RMethod</span></span>
<span id="cb42-16"><a href="#cb42-16"></a>    <span class="kw">public</span> RDataframe <span class="fu">generateDataFrame</span>() {</span>
<span id="cb42-17"><a href="#cb42-17"></a>        RDataframe out = <span class="kw">new</span> <span class="fu">RDataframe</span>();</span>
<span id="cb42-18"><a href="#cb42-18"></a>        <span class="kw">for</span> (<span class="dt">int</span> i=<span class="dv">0</span>; i&lt;<span class="dv">10</span>; i++) {</span>
<span id="cb42-19"><a href="#cb42-19"></a>            <span class="bu">Map</span>&lt;<span class="bu">String</span>,<span class="bu">Object</span>&gt; tmp = <span class="kw">new</span> <span class="bu">LinkedHashMap</span>&lt;<span class="bu">String</span>,<span class="bu">Object</span>&gt;();</span>
<span id="cb42-20"><a href="#cb42-20"></a>            tmp.<span class="fu">put</span>(<span class="st">"index"</span>, i);</span>
<span id="cb42-21"><a href="#cb42-21"></a>            tmp.<span class="fu">put</span>(<span class="st">"value"</span>, <span class="dv">10</span>-i);</span>
<span id="cb42-22"><a href="#cb42-22"></a>            out.<span class="fu">addRow</span>(tmp);</span>
<span id="cb42-23"><a href="#cb42-23"></a>        }</span>
<span id="cb42-24"><a href="#cb42-24"></a>        <span class="kw">return</span> out;</span>
<span id="cb42-25"><a href="#cb42-25"></a>        </span>
<span id="cb42-26"><a href="#cb42-26"></a>    }</span>
<span id="cb42-27"><a href="#cb42-27"></a>    </span>
<span id="cb42-28"><a href="#cb42-28"></a>    <span class="co">/**</span></span>
<span id="cb42-29"><a href="#cb42-29"></a>     <span class="co">*</span> A copy of the ggplot2<span class="co">::</span>diamonds dataframe serialised into java<span class="co">,</span> using</span>
<span id="cb42-30"><a href="#cb42-30"></a>     <span class="co">*</span> RObject<span class="co">.</span>writeRDS<span class="co">,</span> saved within the jar file of the package<span class="co">,</span> and exposed here</span>
<span id="cb42-31"><a href="#cb42-31"></a>     <span class="co">*</span> using RObject<span class="co">.</span>readRDS<span class="co">. </span></span>
<span id="cb42-32"><a href="#cb42-32"></a>     <span class="co">*</span> <span class="an">@return </span>the ggplot2<span class="co">::</span>diamonds dataframe</span>
<span id="cb42-33"><a href="#cb42-33"></a>     <span class="co">*</span> <span class="an">@throws IOException </span>if the serialised data file could not be found </span>
<span id="cb42-34"><a href="#cb42-34"></a>     <span class="co">*/</span></span>
<span id="cb42-35"><a href="#cb42-35"></a>    <span class="at">@RMethod</span>(examples = {</span>
<span id="cb42-36"><a href="#cb42-36"></a>            <span class="st">"J$FeatureTest$diamonds()"</span>,</span>
<span id="cb42-37"><a href="#cb42-37"></a>    })</span>
<span id="cb42-38"><a href="#cb42-38"></a>    <span class="kw">public</span> <span class="dt">static</span> RDataframe <span class="fu">diamonds</span>() <span class="kw">throws</span> <span class="bu">IOException</span> {</span>
<span id="cb42-39"><a href="#cb42-39"></a>        <span class="bu">InputStream</span> is = FeatureTest.<span class="fu">class</span>.<span class="fu">getResourceAsStream</span>(<span class="st">"/diamonds.ser"</span>);</span>
<span id="cb42-40"><a href="#cb42-40"></a>        <span class="kw">if</span>(is==<span class="kw">null</span>) <span class="kw">throw</span> <span class="kw">new</span> <span class="bu">IOException</span>(<span class="st">"Could not locate /diamonds.ser"</span>);</span>
<span id="cb42-41"><a href="#cb42-41"></a>        <span class="kw">return</span> RObject.<span class="fu">readRDS</span>(RDataframe.<span class="fu">class</span>, is);</span>
<span id="cb42-42"><a href="#cb42-42"></a>    }</span>
<span id="cb42-43"><a href="#cb42-43"></a>    </span></code></pre></div>
<p>The basic smoke tests of this are as follows</p>
<div class="sourceCode" id="cb43"><pre class="downlit">
<span class="va">feat1</span><span class="op">$</span><span class="fu">doSomethingWithDataFrame</span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="va"><a href="https://ggplot2.tidyverse.org/reference/diamonds.html">diamonds</a></span><span class="op">)</span></pre></div>
<pre><code>## 2022-05-18 23:25:05,713 INFO uk.co.terminological.rjava.test.FeatureTest [main] dataframe length: 53940</code></pre>
<div class="sourceCode" id="cb45"><pre class="downlit">
<span class="va">feat1</span><span class="op">$</span><span class="fu">generateDataFrame</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">glimpse</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## Rows: 10
## Columns: 2
## $ index &lt;int&gt; 0, 1, 2, 3, 4, 5, 6, 7, 8, 9
## $ value &lt;int&gt; 10, 9, 8, 7, 6, 5, 4, 3, 2, 1</code></pre>
<div class="sourceCode" id="cb47"><pre class="downlit">
<span class="va">J</span><span class="op">$</span><span class="va">FeatureTest</span><span class="op">$</span><span class="fu">diamonds</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">glimpse</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## Rows: 53,940
## Columns: 10
## $ carat   &lt;dbl&gt; 0.23, 0.21, 0.23, 0.29, 0.31, 0.24, 0.24, 0.26, 0.22, 0.23, 0.…
## $ cut     &lt;ord&gt; Ideal, Premium, Good, Premium, Good, Very Good, Very Good, Ver…
## $ color   &lt;ord&gt; E, E, E, I, J, J, I, H, E, H, J, J, F, J, E, E, I, J, J, J, I,…
## $ clarity &lt;ord&gt; SI2, SI1, VS1, VS2, SI2, VVS2, VVS1, SI1, VS2, VS1, SI1, VS1, …
## $ depth   &lt;dbl&gt; 61.5, 59.8, 56.9, 62.4, 63.3, 62.8, 62.3, 61.9, 65.1, 59.4, 64…
## $ table   &lt;dbl&gt; 55, 61, 65, 58, 58, 57, 57, 55, 61, 61, 55, 56, 61, 54, 62, 58…
## $ price   &lt;int&gt; 326, 326, 327, 334, 335, 336, 336, 337, 337, 338, 339, 340, 34…
## $ x       &lt;dbl&gt; 3.95, 3.89, 4.05, 4.20, 4.34, 3.94, 3.95, 4.07, 3.87, 4.00, 4.…
## $ y       &lt;dbl&gt; 3.98, 3.84, 4.07, 4.23, 4.35, 3.96, 3.98, 4.11, 3.78, 4.05, 4.…
## $ z       &lt;dbl&gt; 2.43, 2.31, 2.31, 2.63, 2.75, 2.48, 2.47, 2.53, 2.49, 2.39, 2.…</code></pre>
<div class="sourceCode" id="cb49"><pre class="downlit">
<span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="va">J</span><span class="op">$</span><span class="va">FeatureTest</span><span class="op">$</span><span class="fu">diamonds</span><span class="op">(</span><span class="op">)</span>, <span class="fu">ggplot2</span><span class="fu">::</span><span class="va"><a href="https://ggplot2.tidyverse.org/reference/diamonds.html">diamonds</a></span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"PASS: round tripping ggplot2::diamonds including java serialisation and deserialisation works"</span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"FAIL: serialised diamonds from Java should be identical to the ggplot source"</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<pre><code>## PASS: round tripping ggplot2::diamonds including java serialisation and deserialisation works</code></pre>
</div>
<div id="objects-fluent-apis-and-factory-methods" class="section level2">
<h2 class="hasAnchor">
<a href="#objects-fluent-apis-and-factory-methods" class="anchor"></a>Objects, fluent apis and factory methods</h2>
<p>The generated R6 code can handle return of Java objects to R, as long as they are a part of the api and annotated with <code>@RClass</code>. A common use case for this is fluent Apis, where the Java object is manipulated by a method and returns itself.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb51-1"><a href="#cb51-1"></a>    </span>
<span id="cb51-2"><a href="#cb51-2"></a>    <span class="co">/**</span></span>
<span id="cb51-3"><a href="#cb51-3"></a>     <span class="co">*</span> message desciption</span>
<span id="cb51-4"><a href="#cb51-4"></a>     <span class="co">* </span><span class="an">@return </span>The message <span class="co">(</span>previously set by the constructor<span class="co">)</span></span>
<span id="cb51-5"><a href="#cb51-5"></a>     <span class="co">*/</span></span>
<span id="cb51-6"><a href="#cb51-6"></a>    <span class="at">@RMethod</span></span>
<span id="cb51-7"><a href="#cb51-7"></a>    <span class="kw">public</span> RCharacter <span class="fu">getMessage</span>() {</span>
<span id="cb51-8"><a href="#cb51-8"></a>        <span class="kw">return</span> RConverter.<span class="fu">convert</span>(message);</span>
<span id="cb51-9"><a href="#cb51-9"></a>    }   </span>
<span id="cb51-10"><a href="#cb51-10"></a>    </span>
<span id="cb51-11"><a href="#cb51-11"></a>    <span class="co">/**</span></span>
<span id="cb51-12"><a href="#cb51-12"></a>     <span class="co">*</span> A fluent method which updates the message in this object<span class="co">,</span> returning the</span>
<span id="cb51-13"><a href="#cb51-13"></a>     <span class="co">*</span> same object<span class="co">. </span>This is differentiated from factory methods which produce a new</span>
<span id="cb51-14"><a href="#cb51-14"></a>     <span class="co">*</span> instance of the same class by checking to see if the returned Java object is equal</span>
<span id="cb51-15"><a href="#cb51-15"></a>     <span class="co">*</span> to the calling Java object<span class="co">.</span>  </span>
<span id="cb51-16"><a href="#cb51-16"></a>     <span class="co">*</span> <span class="an">@param message </span>the message is a string</span>
<span id="cb51-17"><a href="#cb51-17"></a>     <span class="co">*</span> <span class="an">@return </span>this should return exactly the same R6 object<span class="co">.</span></span>
<span id="cb51-18"><a href="#cb51-18"></a>     <span class="co">*/</span></span>
<span id="cb51-19"><a href="#cb51-19"></a>    <span class="at">@RMethod</span></span>
<span id="cb51-20"><a href="#cb51-20"></a>    <span class="kw">public</span> FeatureTest <span class="fu">fluentSetMessage</span>(<span class="at">@RDefault</span>(rCode = <span class="st">"</span><span class="sc">\"</span><span class="st">hello</span><span class="sc">\n</span><span class="st">world</span><span class="sc">\"</span><span class="st">"</span>) RCharacter message) {</span>
<span id="cb51-21"><a href="#cb51-21"></a>        <span class="kw">this</span>.<span class="fu">message</span> = message.<span class="fu">toString</span>();</span>
<span id="cb51-22"><a href="#cb51-22"></a>        <span class="kw">return</span> <span class="kw">this</span>;</span>
<span id="cb51-23"><a href="#cb51-23"></a>    }</span>
<span id="cb51-24"><a href="#cb51-24"></a>    </span></code></pre></div>
<p>The <code>JavaApi</code> root manages R’s perspective on the identity of objects in Java. This allows for fluent api methods, and method chaining. This is not flawless but should work for most common scenarios. It is possible that complex edge cases may appear equal in Java but not identical in R, so true equality should rely on the Java <code>equals()</code> method.</p>
<div class="sourceCode" id="cb52"><pre class="downlit">
<span class="va">feat1</span><span class="op">$</span><span class="fu">getMessage</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## [1] "Hello world. Creating a new object"</code></pre>
<div class="sourceCode" id="cb54"><pre class="downlit">
<span class="va">feat2</span> <span class="op">=</span> <span class="va">feat1</span><span class="op">$</span><span class="fu">fluentSetMessage</span><span class="op">(</span><span class="st">"Hello world. updating message."</span><span class="op">)</span>
<span class="va">feat2</span><span class="op">$</span><span class="fu">getMessage</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## [1] "Hello world. updating message."</code></pre>
<div class="sourceCode" id="cb56"><pre class="downlit">
<span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="va">feat1</span>,<span class="va">feat2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"PASS: the return value of a fluent setter returns the same object as the original"</span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="va">.jobj</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">feat2</span><span class="op">$</span><span class="va">.jobj</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="va">.jobj</span><span class="op">$</span><span class="fu">equals</span><span class="op">(</span><span class="va">feat2</span><span class="op">$</span><span class="va">.jobj</span><span class="op">)</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"FAIL: these should have been identical"</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<pre><code>## PASS: the return value of a fluent setter returns the same object as the original</code></pre>
<div class="sourceCode" id="cb58"><pre class="downlit">
<span class="kw">if</span> <span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">equals</span><span class="op">(</span><span class="va">feat2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"PASS: java based equality detection is supported"</span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"FAIL: these should have been equal"</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<pre><code>## PASS: java based equality detection is supported</code></pre>
<div class="sourceCode" id="cb60"><pre class="downlit">
<span class="va">feat1</span><span class="op">$</span><span class="fu">getMessage</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## [1] "Hello world. updating message."</code></pre>
<div class="sourceCode" id="cb62"><pre class="downlit">
<span class="co"># Operations on feat2 are occurring on feat1 as they are the same underlying object</span>
<span class="va">feat2</span><span class="op">$</span><span class="fu">fluentSetMessage</span><span class="op">(</span><span class="st">"Hello world. updating message again."</span><span class="op">)</span>
<span class="va">feat1</span><span class="op">$</span><span class="fu">getMessage</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## [1] "Hello world. updating message again."</code></pre>
<p>Factory methods allow java methods to create and return Java objects. This is supported as long as the objects are a part of the api and annotated with <code>@RClass</code>. Arbitrary java objects are not supported as return types and java code that tries to return such objects will throw an exception during the maven packaging phase. This is by design to enforce formal contracts between the Java code and the R api. If you want dynamic manipulation of the Java objects then the <em>jsr223</em> plugin is more appropriate for you.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb64-1"><a href="#cb64-1"></a>    </span>
<span id="cb64-2"><a href="#cb64-2"></a>    <span class="co">/**</span></span>
<span id="cb64-3"><a href="#cb64-3"></a>     <span class="co">*</span> A factory or builder method which constructs an object of another class from some parameters </span>
<span id="cb64-4"><a href="#cb64-4"></a>     <span class="co">* </span><span class="an">@param a </span>the first parameter</span>
<span id="cb64-5"><a href="#cb64-5"></a>     <span class="co">*</span> <span class="an">@param b </span>the second parameter</span>
<span id="cb64-6"><a href="#cb64-6"></a>     <span class="co">*</span> <span class="an">@return </span>A MoreFeatureTest R6 reference</span>
<span id="cb64-7"><a href="#cb64-7"></a>     <span class="co">*/</span></span>
<span id="cb64-8"><a href="#cb64-8"></a>    <span class="at">@RMethod</span></span>
<span id="cb64-9"><a href="#cb64-9"></a>    <span class="kw">public</span> MoreFeatureTest <span class="fu">factoryMethod</span>(RCharacter a, <span class="at">@RDefault</span>(rCode = <span class="st">"as.character(Sys.Date())"</span>) RCharacter b) {</span>
<span id="cb64-10"><a href="#cb64-10"></a>        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">MoreFeatureTest</span>(a,b);</span>
<span id="cb64-11"><a href="#cb64-11"></a>    }</span>
<span id="cb64-12"><a href="#cb64-12"></a>    </span>
<span id="cb64-13"><a href="#cb64-13"></a>    <span class="at">@RMethod</span></span>
<span id="cb64-14"><a href="#cb64-14"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">objectAsParameter</span>(MoreFeatureTest otherObj) {</span>
<span id="cb64-15"><a href="#cb64-15"></a>        <span class="kw">return</span> otherObj.<span class="fu">toString</span>();</span>
<span id="cb64-16"><a href="#cb64-16"></a>    }</span></code></pre></div>
<p>This java code from refers to another class - <code>MoreFeatureTest</code> which has the following basic structure:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb65-1"><a href="#cb65-1"></a><span class="co">/**</span></span>
<span id="cb65-2"><a href="#cb65-2"></a> <span class="co">*</span> This has no documentation</span>
<span id="cb65-3"><a href="#cb65-3"></a> <span class="co">*/</span></span>
<span id="cb65-4"><a href="#cb65-4"></a><span class="at">@RClass</span></span>
<span id="cb65-5"><a href="#cb65-5"></a><span class="kw">public</span> <span class="kw">class</span> MoreFeatureTest {</span>
<span id="cb65-6"><a href="#cb65-6"></a></span>
<span id="cb65-7"><a href="#cb65-7"></a>    <span class="bu">String</span> message1;</span>
<span id="cb65-8"><a href="#cb65-8"></a>    <span class="bu">String</span> message2;</span>
<span id="cb65-9"><a href="#cb65-9"></a>    </span>
<span id="cb65-10"><a href="#cb65-10"></a>    <span class="dt">static</span> <span class="bu">Logger</span> log = LoggerFactory.<span class="fu">getLogger</span>(MoreFeatureTest.<span class="fu">class</span>); </span>
<span id="cb65-11"><a href="#cb65-11"></a>    </span>
<span id="cb65-12"><a href="#cb65-12"></a>    <span class="co">/**</span></span>
<span id="cb65-13"><a href="#cb65-13"></a>     <span class="co">*</span> the first constructor is used if there are none annotated </span>
<span id="cb65-14"><a href="#cb65-14"></a>     <span class="co">* </span><span class="an">@param message1 </span><span class="co">-</span> the message to be printed </span>
<span id="cb65-15"><a href="#cb65-15"></a>     <span class="co">*</span> <span class="an">@param message2 </span><span class="co">-</span> will be used for toString</span>
<span id="cb65-16"><a href="#cb65-16"></a>     <span class="co">*/</span></span>
<span id="cb65-17"><a href="#cb65-17"></a>    <span class="kw">public</span> <span class="fu">MoreFeatureTest</span>(RCharacter message1, RCharacter message2) {</span>
<span id="cb65-18"><a href="#cb65-18"></a>        <span class="kw">this</span>.<span class="fu">message1</span> = message1.<span class="fu">toString</span>();</span>
<span id="cb65-19"><a href="#cb65-19"></a>        <span class="kw">this</span>.<span class="fu">message2</span> = message2.<span class="fu">toString</span>();</span>
<span id="cb65-20"><a href="#cb65-20"></a>        log.<span class="fu">info</span>(<span class="st">"constuctor: {}, {}"</span>,<span class="kw">this</span>.<span class="fu">message1</span>, <span class="kw">this</span>.<span class="fu">message2</span>);</span>
<span id="cb65-21"><a href="#cb65-21"></a>    }</span>
<span id="cb65-22"><a href="#cb65-22"></a>    </span>
<span id="cb65-23"><a href="#cb65-23"></a>    <span class="co">/**</span> A static object constructor</span>
<span id="cb65-24"><a href="#cb65-24"></a>     <span class="co">* </span><span class="an">@param message1 </span><span class="co">-</span> the message to be printed </span>
<span id="cb65-25"><a href="#cb65-25"></a>     <span class="co">*</span> <span class="an">@param message2 </span><span class="co">-</span> will be used for toString</span>
<span id="cb65-26"><a href="#cb65-26"></a>     <span class="co">*</span> <span class="an">@return </span>A MoreFeatureTest R6 object</span>
<span id="cb65-27"><a href="#cb65-27"></a>     <span class="co">*/</span></span>
<span id="cb65-28"><a href="#cb65-28"></a>    <span class="at">@RMethod</span>(examples = {</span>
<span id="cb65-29"><a href="#cb65-29"></a>        <span class="st">"J$MoreFeatureTest$create('Hello,',' World')"</span>,</span>
<span id="cb65-30"><a href="#cb65-30"></a>    })</span>
<span id="cb65-31"><a href="#cb65-31"></a>    <span class="kw">public</span> <span class="dt">static</span> MoreFeatureTest <span class="fu">create</span>(RCharacter message1, RCharacter message2) {</span>
<span id="cb65-32"><a href="#cb65-32"></a>        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">MoreFeatureTest</span>(message1,message2);</span>
<span id="cb65-33"><a href="#cb65-33"></a>    }</span>
<span id="cb65-34"><a href="#cb65-34"></a>    </span>
<span id="cb65-35"><a href="#cb65-35"></a>...</span>
<span id="cb65-36"><a href="#cb65-36"></a>}</span></code></pre></div>
<p>The <code>FeatureTest.factoryMethod(a,b)</code> method allows us to construct instances of another class. This enables builder patterns in the R api. The <code>MoreFeatureTest.create(message1,message2)</code> method demonstrates static factory methods, which return instances of the same class. Static methods are implemented as methods in the <code>JavaApi</code> root, as demonstrated here, and accessed through the root object <code>J</code>:</p>
<div class="sourceCode" id="cb66"><pre class="downlit">
<span class="co"># factory method from builder class</span>
<span class="va">moreFeat1</span> <span class="op">=</span> <span class="va">feat1</span><span class="op">$</span><span class="fu">factoryMethod</span><span class="op">(</span><span class="st">"Hello"</span>,<span class="st">"World"</span><span class="op">)</span></pre></div>
<pre><code>## 2022-05-18 23:25:07,683 INFO uk.co.terminological.rjava.test.MoreFeatureTest [main] constuctor: Hello, World</code></pre>
<div class="sourceCode" id="cb68"><pre class="downlit">
<span class="co"># static factory method accessed through the root of the API</span>
<span class="va">moreFeat2</span> <span class="op">=</span> <span class="va">J</span><span class="op">$</span><span class="va">MoreFeatureTest</span><span class="op">$</span><span class="fu">create</span><span class="op">(</span><span class="st">"Ola"</span>,<span class="st">"El Mundo"</span><span class="op">)</span></pre></div>
<pre><code>## 2022-05-18 23:25:07,687 INFO uk.co.terminological.rjava.test.MoreFeatureTest [main] constuctor: Ola, El Mundo</code></pre>
<div class="sourceCode" id="cb70"><pre class="downlit">
<span class="co"># either of these can be passed as a parameter</span>
<span class="va">feat1</span><span class="op">$</span><span class="fu">objectAsParameter</span><span class="op">(</span><span class="va">moreFeat1</span><span class="op">)</span></pre></div>
<pre><code>## [1] "toString: World"</code></pre>
</div>
<div id="logging-printing-and-exceptions" class="section level2">
<h2 class="hasAnchor">
<a href="#logging-printing-and-exceptions" class="anchor"></a>Logging, printing and exceptions</h2>
<p>The logging sub-system is based on <code>slf4j</code> with a <code>log4j2</code> implementation. These are specified in the <code>r6-generator-runtime</code> dependency pom, so anything that imports that will have them as a transitive dependency. These are needed as dynamic alteration of the logging level from R is dependent on implementation details of <code>log4j</code>. This is maybe possible to remove in the future.</p>
<p>Exceptions thrown from Java are handled in the same way as <em>rJava</em>, and printed messages are seen on the R console as expected. However rJava does something strange to messages from <code>System.out</code> that means they do not appear in knitr output. To resolve this a unsightly workaround (hack) has been adopted that collects messages from system out and prints them after the Java method has completed. This has the potential to cause all sorts of issues, which I think I have mostly resolved.</p>
<p>The logging level can be controlled at runtime by a function in the <code>JavaApi</code> root. Logging can be configured dynamically with a <code>log4j</code> properties file (not shown) to enable file based logging, for example.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb72-1"><a href="#cb72-1"></a>    </span>
<span id="cb72-2"><a href="#cb72-2"></a>    <span class="at">@RMethod</span> </span>
<span id="cb72-3"><a href="#cb72-3"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testLogging</span>() {</span>
<span id="cb72-4"><a href="#cb72-4"></a>        log.<span class="fu">error</span>(<span class="st">"An error"</span>);</span>
<span id="cb72-5"><a href="#cb72-5"></a>        log.<span class="fu">warn</span>(<span class="st">"A warning"</span>);</span>
<span id="cb72-6"><a href="#cb72-6"></a>        log.<span class="fu">info</span>(<span class="st">"A info"</span>);</span>
<span id="cb72-7"><a href="#cb72-7"></a>        log.<span class="fu">debug</span>(<span class="st">"A debug"</span>);</span>
<span id="cb72-8"><a href="#cb72-8"></a>        log.<span class="fu">trace</span>(<span class="st">"A trace"</span>);</span>
<span id="cb72-9"><a href="#cb72-9"></a>    }</span>
<span id="cb72-10"><a href="#cb72-10"></a>            </span>
<span id="cb72-11"><a href="#cb72-11"></a>    <span class="at">@RMethod</span></span>
<span id="cb72-12"><a href="#cb72-12"></a>    <span class="kw">public</span> RCharacter <span class="fu">throwCatchable</span>() <span class="kw">throws</span> <span class="bu">Exception</span> {</span>
<span id="cb72-13"><a href="#cb72-13"></a>        <span class="kw">throw</span> <span class="kw">new</span> <span class="bu">Exception</span>(<span class="st">"A catchable exception has been thrown"</span>);</span>
<span id="cb72-14"><a href="#cb72-14"></a>    }</span>
<span id="cb72-15"><a href="#cb72-15"></a>    </span>
<span id="cb72-16"><a href="#cb72-16"></a>    <span class="at">@RMethod</span></span>
<span id="cb72-17"><a href="#cb72-17"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">printMessage</span>() {</span>
<span id="cb72-18"><a href="#cb72-18"></a>        <span class="bu">System</span>.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">"Printed in java: "</span>+message1+<span class="st">" "</span>+message2);</span>
<span id="cb72-19"><a href="#cb72-19"></a>    }</span>
<span id="cb72-20"><a href="#cb72-20"></a>    </span>
<span id="cb72-21"><a href="#cb72-21"></a>    <span class="at">@RMethod</span></span>
<span id="cb72-22"><a href="#cb72-22"></a>    <span class="kw">public</span> RCharacter <span class="fu">throwRuntime</span>() {</span>
<span id="cb72-23"><a href="#cb72-23"></a>        <span class="kw">throw</span> <span class="kw">new</span> <span class="bu">RuntimeException</span>(<span class="st">"A runtime exception has been thrown"</span>);</span>
<span id="cb72-24"><a href="#cb72-24"></a>    }</span>
<span id="cb72-25"><a href="#cb72-25"></a>    </span>
<span id="cb72-26"><a href="#cb72-26"></a>    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">toString</span>() {</span>
<span id="cb72-27"><a href="#cb72-27"></a>        <span class="kw">return</span> <span class="st">"toString: "</span>+message2;</span>
<span id="cb72-28"><a href="#cb72-28"></a>    }</span></code></pre></div>
<div class="sourceCode" id="cb73"><pre class="downlit">
<span class="co"># System.out printing</span>
<span class="va">moreFeat1</span><span class="op">$</span><span class="fu">printMessage</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## Printed in java: Hello World</code></pre>
<div class="sourceCode" id="cb75"><pre class="downlit">
<span class="co"># Testing logging levels</span>
<span class="va">J</span><span class="op">$</span><span class="fu">changeLogLevel</span><span class="op">(</span><span class="st">"ALL"</span><span class="op">)</span>
<span class="va">moreFeat1</span><span class="op">$</span><span class="fu">testLogging</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## 2022-05-18 23:25:07,825 ERROR uk.co.terminological.rjava.test.MoreFeatureTest [main] An error
## 2022-05-18 23:25:07,825 WARN uk.co.terminological.rjava.test.MoreFeatureTest [main] A warning
## 2022-05-18 23:25:07,825 INFO uk.co.terminological.rjava.test.MoreFeatureTest [main] A info
## 2022-05-18 23:25:07,825 DEBUG uk.co.terminological.rjava.test.MoreFeatureTest [main] A debug
## 2022-05-18 23:25:07,825 TRACE uk.co.terminological.rjava.test.MoreFeatureTest [main] A trace</code></pre>
<div class="sourceCode" id="cb77"><pre class="downlit">
<span class="co"># Suppressing errors</span>
<span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="va">moreFeat1</span><span class="op">$</span><span class="fu">throwCatchable</span><span class="op">(</span><span class="op">)</span>,silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="co"># Handling errors</span>
<span class="kw"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span><span class="op">(</span>
  <span class="op">{</span>
    <span class="va">moreFeat1</span><span class="op">$</span><span class="fu">throwRuntime</span><span class="op">(</span><span class="op">)</span>
  <span class="op">}</span>, 
  error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"the error object has a set of classes: "</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span>,collapse<span class="op">=</span><span class="st">";"</span><span class="op">)</span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="st">"error: "</span>,<span class="va">e</span><span class="op">$</span><span class="va">message</span><span class="op">)</span>
    <span class="co"># the e$jobj entry gives native access to the throwable java object thanks to rJava.</span>
    <span class="va">e</span><span class="op">$</span><span class="va">jobj</span><span class="op">$</span><span class="fu">printStackTrace</span><span class="op">(</span><span class="op">)</span>
  <span class="op">}</span>, 
  finally <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"finally"</span><span class="op">)</span>
<span class="op">)</span></pre></div>
<pre><code>## the error object has a set of classes: RuntimeException;Exception;Throwable;Object;error;condition</code></pre>
<pre><code>## Warning in value[[3L]](cond): error: java.lang.RuntimeException: A runtime
## exception has been thrown</code></pre>
<pre><code>## [1] "finally"</code></pre>
<div class="sourceCode" id="cb81"><pre class="downlit">
<span class="va">J</span><span class="op">$</span><span class="fu">changeLogLevel</span><span class="op">(</span><span class="st">"ERROR"</span><span class="op">)</span>
<span class="va">moreFeat1</span><span class="op">$</span><span class="fu">testLogging</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## 2022-05-18 23:25:07,831 ERROR uk.co.terminological.rjava.test.MoreFeatureTest [main] An error</code></pre>
<div class="sourceCode" id="cb83"><pre class="downlit">
<span class="co"># J$reconfigureLog("/path/to/log4j.prop")</span></pre></div>
</div>
<div id="finalising-and-clean-up" class="section level2">
<h2 class="hasAnchor">
<a href="#finalising-and-clean-up" class="anchor"></a>Finalising and clean up</h2>
<p>The java objects bound to R instances will stay in memory whilst they are needed. When they go out of scope they should automatically be garbage collected as a native feature of <code>rJava</code>. R6 object finalizers are also generated when specified by the code and these are triggered during release of the Java objects, and may call any closing code needed in the java library (e.g. closing input streams etc).</p>
<div class="sourceCode" id="cb84"><pre class="downlit">
<span class="va">feat1</span> <span class="op">=</span> <span class="va">J</span><span class="op">$</span><span class="va">FeatureTest</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>logMessage <span class="op">=</span> <span class="st">"Hello world. Creating a new object"</span><span class="op">)</span>
<span class="va">feat1</span><span class="op">$</span><span class="fu">doHelloWorld</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## [1] "Hello world from Java!"</code></pre>
<p>When an object goes out of scope the finalizer will be called. This can happen much later, and any errors thrown by the finaliser code could cause issues. Code run in these finalizers can throw unchecked exceptions which are ignored and converted to logged errors.</p>
<div class="sourceCode" id="cb86"><pre class="downlit">
<span class="va">feat1</span> <span class="op">=</span> <span class="cn">NULL</span>
<span class="fu"><a href="https://rdrr.io/r/base/gc.html">gc</a></span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## 2022-05-18 23:25:08,058 ERROR testRapi [main] Errors from the finalizer are ignored</code></pre>
<pre><code>##           used (Mb) gc trigger  (Mb) max used  (Mb)
## Ncells 1227701 65.6    2237112 119.5  2237112 119.5
## Vcells 2524999 19.3    8388608  64.0  7429630  56.7</code></pre>
<p>The finalizer should also be called implicitly when the R6 object goes out of scope in R.</p>
</div>
<div id="support-for-debugging" class="section level2">
<h2 class="hasAnchor">
<a href="#support-for-debugging" class="anchor"></a>Support for debugging</h2>
<p>Debugging compiled java code running in the context of a R is not for the faint-hearted. It definitely makes sense to test and debug the java code in Java first. To make this possible it is useful to be able to serialise some test data in the exact format in which it will arrive in Java from R. To that end all the Java structures supported can be serialised, and de-serialised for testing purposes. The <code>testRapi</code> library presented here has a set of functions that facilitate this as static methods of <code>J$Serialiser</code>.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode java"><code class="sourceCode java"><span id="cb89-1"><a href="#cb89-1"></a>    </span>
<span id="cb89-2"><a href="#cb89-2"></a>    <span class="at">@RMethod</span></span>
<span id="cb89-3"><a href="#cb89-3"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">serialiseDataframe</span>(RDataframe dataframe, <span class="bu">String</span> filename) <span class="kw">throws</span> <span class="bu">IOException</span> {</span>
<span id="cb89-4"><a href="#cb89-4"></a>        <span class="bu">FileOutputStream</span> fos = <span class="kw">new</span> <span class="bu">FileOutputStream</span>(filename);</span>
<span id="cb89-5"><a href="#cb89-5"></a>        dataframe.<span class="fu">writeRDS</span>(fos);</span>
<span id="cb89-6"><a href="#cb89-6"></a>        log.<span class="fu">info</span>(<span class="st">"dataframe written to: "</span>+filename);</span>
<span id="cb89-7"><a href="#cb89-7"></a>    }</span>
<span id="cb89-8"><a href="#cb89-8"></a>    </span>
<span id="cb89-9"><a href="#cb89-9"></a>    <span class="at">@RMethod</span></span>
<span id="cb89-10"><a href="#cb89-10"></a>    <span class="kw">public</span> <span class="dt">static</span> RDataframe <span class="fu">deserialiseDataframe</span>(<span class="bu">String</span> filename) <span class="kw">throws</span> <span class="bu">IOException</span> {</span>
<span id="cb89-11"><a href="#cb89-11"></a>        <span class="bu">InputStream</span> is = Files.<span class="fu">newInputStream</span>(Paths.<span class="fu">get</span>(filename));</span>
<span id="cb89-12"><a href="#cb89-12"></a>        <span class="kw">if</span>(is==<span class="kw">null</span>) <span class="kw">throw</span> <span class="kw">new</span> <span class="bu">IOException</span>(<span class="st">"Could not locate "</span>+filename);</span>
<span id="cb89-13"><a href="#cb89-13"></a>        <span class="kw">return</span> RObject.<span class="fu">readRDS</span>(RDataframe.<span class="fu">class</span>, is);</span>
<span id="cb89-14"><a href="#cb89-14"></a>    }</span>
<span id="cb89-15"><a href="#cb89-15"></a>    </span></code></pre></div>
<div class="sourceCode" id="cb90"><pre class="downlit">
<span class="va">s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"diamonds"</span>, fileext <span class="op">=</span> <span class="st">".ser"</span><span class="op">)</span>
<span class="va">J</span><span class="op">$</span><span class="va">Serialiser</span><span class="op">$</span><span class="fu">serialiseDataframe</span><span class="op">(</span>dataframe <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="va"><a href="https://ggplot2.tidyverse.org/reference/diamonds.html">diamonds</a></span>, filename <span class="op">=</span> <span class="va">s</span><span class="op">)</span>
<span class="va">J</span><span class="op">$</span><span class="va">Serialiser</span><span class="op">$</span><span class="fu">deserialiseDataframe</span><span class="op">(</span>filename<span class="op">=</span><span class="va">s</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">glimpse</span><span class="op">(</span><span class="op">)</span></pre></div>
<pre><code>## Rows: 53,940
## Columns: 10
## $ carat   &lt;dbl&gt; 0.23, 0.21, 0.23, 0.29, 0.31, 0.24, 0.24, 0.26, 0.22, 0.23, 0.…
## $ cut     &lt;ord&gt; Ideal, Premium, Good, Premium, Good, Very Good, Very Good, Ver…
## $ color   &lt;ord&gt; E, E, E, I, J, J, I, H, E, H, J, J, F, J, E, E, I, J, J, J, I,…
## $ clarity &lt;ord&gt; SI2, SI1, VS1, VS2, SI2, VVS2, VVS1, SI1, VS2, VS1, SI1, VS1, …
## $ depth   &lt;dbl&gt; 61.5, 59.8, 56.9, 62.4, 63.3, 62.8, 62.3, 61.9, 65.1, 59.4, 64…
## $ table   &lt;dbl&gt; 55, 61, 65, 58, 58, 57, 57, 55, 61, 61, 55, 56, 61, 54, 62, 58…
## $ price   &lt;int&gt; 326, 326, 327, 334, 335, 336, 336, 337, 337, 338, 339, 340, 34…
## $ x       &lt;dbl&gt; 3.95, 3.89, 4.05, 4.20, 4.34, 3.94, 3.95, 4.07, 3.87, 4.00, 4.…
## $ y       &lt;dbl&gt; 3.98, 3.84, 4.07, 4.23, 4.35, 3.96, 3.98, 4.11, 3.78, 4.05, 4.…
## $ z       &lt;dbl&gt; 2.43, 2.31, 2.31, 2.63, 2.75, 2.48, 2.47, 2.53, 2.49, 2.39, 2.…</code></pre>
<p>With serialised test data, as dataframes, lists or named lists, development of java functions and unit tests can be created that output values of the correct <code>RObject</code> datatype. Correct packaging and integration with R is a question of running <code>mvn install</code> to compile the Java into a jar file and generate R library code, then using <code><a href="https://devtools.r-lib.org/reference/install.html">devtools::install</a></code> to install the generated R library.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb92-1"><a href="#cb92-1"></a><span class="co"># compile Java code and package R library using `mvn install` command</span></span>
<span id="cb92-2"><a href="#cb92-2"></a><span class="bu">cd</span> ~/Git/r6-generator-maven-plugin-test</span>
<span id="cb92-3"><a href="#cb92-3"></a><span class="ex">mvn</span> install</span></code></pre></div>
<div class="sourceCode" id="cb93"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span><span class="op">(</span><span class="st">"~/Git/r6-generator-maven-plugin-test"</span><span class="op">)</span>
<span class="co"># remove previously installed versions</span>
<span class="kw"><a href="https://rdrr.io/r/base/try.html">try</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/detach.html">detach</a></span><span class="op">(</span><span class="st">"package:testRapi"</span>, unload <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/remove.packages.html">remove.packages</a></span><span class="op">(</span><span class="st">"testRapi"</span><span class="op">)</span>
<span class="co"># rm(list = ls()) may be required to clear old versions of the library code</span>
<span class="co"># Restarting R maybe also required if there was a running java VM otherwise changes to the jars on the classpath are not picked up.</span>
<span class="co"># install locally compiled R library:</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/install.html">install</a></span><span class="op">(</span><span class="st">"~/Git/r6-generator-maven-plugin-test/r-library/"</span>, upgrade <span class="op">=</span> <span class="st">"never"</span><span class="op">)</span>
<span class="co"># N.B. devtools::load_all() does not appear to always successfully pick up changes in the compiled java code</span></pre></div>
<p>For initial integration testing there is a debug flag in the maven <code>pom.xml</code> that enables remote java debugging to the initialized when the library is first loaded in R. When set to true a java debugging session on port 8998 is opened which can be connected to as a remote java application. This allows breakpoints to be set on Java code and the state of the JVM to be inspected when Java code is executed from R, however Java code changes cannot be hot-swapped into the running JVM, and so debugging integration issues is relatively limited. For more details see the <a href="./R6-generator-maven-config">Maven configuration vignette</a>.</p>
<p>There are other limitations with enabling java debugging, not least being the potential for port conflicts with multiple running instances of the development library, and caching issues between running and loaded versions of the Java code. Whilst not too painful (compared to the alternatives) this is very definitely not a REPL experience and reserved for the last stage of debugging. Part of the purpose of strongly enforcing a datatype conversion contract between Java and R, and extensive use of code generation, is to decouple Java and R development as much as possible (N.B. do as I say - not as I do).</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Rob Challen, given family, terminological.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
