<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R6 Generator Maven Plugin: Key features • testRapi</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="R6 Generator Maven Plugin: Key features">
<meta property="og:description" content="testRapi">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">testRapi</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.02</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/R6-generator-datatypes.html">R6 Generator Maven Plugin: Datatype conversion</a>
    </li>
    <li>
      <a href="../articles/R6-generator-features.html">R6 Generator Maven Plugin: Key features</a>
    </li>
    <li>
      <a href="../articles/R6-generator-intro.html">R6 Generator Maven Plugin: Bridging Java and R6 for Package Development</a>
    </li>
    <li>
      <a href="../articles/R6-generator-maven-config.html">R6 Generator Maven Plugin: Metadata and Maven configuration</a>
    </li>
    <li>
      <a href="../articles/R6-generator-runtime.html">R6 Generator Runtime: Using R Datatypes in Java</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>R6 Generator Maven Plugin: Key features</h1>
                        <h4 data-toc-skip class="author">Rob Challen</h4>
            
            <h4 data-toc-skip class="date">19/10/2020</h4>
      
      
      <div class="hidden name"><code>R6-generator-features.Rmd</code></div>

    </div>

    
    
<div class="watermark">
DRAFT
</div>
<div class="section level2">
<h2 id="features">Features<a class="anchor" aria-label="anchor" href="#features"></a>
</h2>
<p>The <code>FeatureTest</code> Java class is designed to showcase the main aspects of the R6 Generator Maven Plugin, and serves as a quick guide to Java programmers wishing to use the plugin. The source of the <code>FeatureTest</code> class is shown below, where the use of the Java annotations <code>@RClass</code> and <code>@RMethod</code> tag a class, and specific methods in that class for use in R. The code structure, parameters and return values or the tagged classes and methods are used to create an equivalent R6 class structure in an R library. In general Javadoc comments and tags are used to document the library, and where there are no applicable tags specific fields in the <code>@RClass</code> and <code>@RMethod</code> annotations can been used to specify needed imports, suggested R package dependencies and provide specific example code if needed.</p>
<div class="sourceCode"><pre class="sourceCode java"><code class="sourceCode java"><span class="co">/**</span>
 <span class="co">*</span> A test of the R6 generator templating
 <span class="co">*</span> 
 <span class="co">*</span> The feature test should allow mathjax in javadoc
 <span class="co">*</span> 
 <span class="co">*</span> <span class="co">$$</span>e <span class="co">=</span> mc<span class="co">^2$$</span>
 <span class="co">*</span> 
 <span class="co">*</span> 
 <span class="co">*</span> this is a details comment 
 <span class="co">* </span><span class="kw">@author </span>given family email<span class="co">@</span>example<span class="co">.</span>com ORCIDID
 <span class="co">*</span> 
 <span class="co">*/</span>
<span class="at">@RClass</span>(
        imports = {<span class="st">"ggplot2"</span>,<span class="st">"dplyr"</span>},
        suggests = {<span class="st">"roxygen2"</span>,<span class="st">"devtools"</span>}
        )
<span class="kw">public</span> <span class="kw">class</span> FeatureTest {

    <span class="bu">String</span> message;
    <span class="dt">static</span> <span class="bu">Logger</span> log = LoggerFactory.<span class="fu">getLogger</span>(FeatureTest.<span class="fu">class</span>);
    
    <span class="co">/**</span>
     <span class="co">*</span> A maximum of one constructor of any signature can be used<span class="co">. </span><span class="kw">&lt;br&gt;</span>
     <span class="co">*</span> 
     <span class="co">*</span> If different constructors are needed then they may be used but not 
     <span class="co">*</span> included in the R Api <span class="co">(</span>i<span class="co">.</span>e<span class="co">.</span> not annotated with <span class="co">@</span>RMethod<span class="co">.)</span> <span class="kw">&lt;br&gt;</span>
     <span class="co">*</span> 
     <span class="co">*</span> Static factory methods can be used instead<span class="co">.</span>
     <span class="co">*</span> <span class="kw">@param logMessage </span><span class="co">-</span> a message which will be logged
     <span class="co">*/</span>
    <span class="at">@RMethod</span>(examples = {
            <span class="st">"minExample = J$FeatureTest$new('Hello from Java constructor!')"</span>,
        })
    <span class="kw">public</span> <span class="fu">FeatureTest</span>(<span class="bu">String</span> logMessage) {
        log.<span class="fu">info</span>(logMessage);
        <span class="kw">this</span>.<span class="fu">message</span> = logMessage;
    }
    
...
}</code></pre></div>
<p>The packaging of this class into an R library is described <a href="./R6-generator-intro">elsewhere</a>. The package name (in this case <code>testRapi</code>), the directory of the library (in this example <code>~/Git/r6-generator-maven-plugin-test/r-library/</code>) and other metadata such as author and license details are defined in the Maven plugin configuration (in a file named <code>pom.xml</code>). This configuration is described in detail <a href="./R6-generator-maven-config">elsewhere</a>. For the purposes of this we assume the Java code has been compiled, generating the <code>testRapi</code> R package which is ready for installation.</p>
</div>
<div class="section level2">
<h2 id="installation-and-instantiation">Installation and instantiation<a class="anchor" aria-label="anchor" href="#installation-and-instantiation"></a>
</h2>
<p>The generated R package can be installed into R in more or less the same way as any other R library, depending on how it is deployed. Typical scenarios would be pushing the whole Java project to Github and installing to R from Github using <code><a href="https://rdrr.io/pkg/devtools/man/remote-reexports.html" class="external-link">devtools::install_github()</a></code>, installing directly from the local filesystem, with <code><a href="https://rdrr.io/pkg/devtools/man/install.html" class="external-link">devtools::install()</a></code>, or submitting the R library sub-directory as a project to CRAN and installing from there, using <code><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages()</a></code>.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># not run</span>
<span class="co"># remove installed versions</span>
<span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/detach.html" class="external-link">detach</a></span><span class="op">(</span><span class="st">"package:testRapi"</span>, unload <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/remove.packages.html" class="external-link">remove.packages</a></span><span class="op">(</span><span class="st">"testRapi"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span>list <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Restarting R maybe also required if there was a running java VM.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># locally compiled</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/devtools/man/install.html" class="external-link">install</a></span><span class="op">(</span><span class="st">"~/Git/r6-generator-maven-plugin-test/r-library/"</span>, upgrade <span class="op">=</span> <span class="st">"never"</span><span class="op">)</span>
<span class="co"># pushed to github</span>
<span class="co"># devtools::install_github("terminological/r6-generator-maven-plugin-test", subdir = "r-library", upgrade = "never")</span>
<span class="co"># submitted to CRAN</span>
<span class="co"># install.packages("testRapi")</span>
<span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"./codeSnip.R"</span><span class="op">)</span></code></pre></div>
<p>The R6 api to the Java classes requires a running instance of the Java Virtual Machine and JNI bridge provided by <em>rJava</em>. It also requires Java classpath dependencies to be loaded and application logging to be initialised. This is all managed by a specific generated R6 class called <code>JavaApi</code> and creating a singleton instance of this is the first step to using the library in R. In these examples the singleton instance <code>J</code> is referred to as the “root” of the api, as all the functions of the API stem from it.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">J</span> <span class="op">=</span> <span class="fu">testRapi</span><span class="fu">::</span><span class="va"><a href="../reference/JavaApi.html">JavaApi</a></span><span class="op">$</span><span class="fu">get</span><span class="op">(</span>logLevel <span class="op">=</span> <span class="st">"WARN"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Initialising A test library</span></code></pre>
<pre><code><span class="co">## Version: 0.02</span></code></pre>
<pre><code><span class="co">## Generated: 2021-12-27T18:17:36.529</span></code></pre>
<pre><code><span class="co">## Adding to classpath: /tmp/RtmpAf0pAv/temp_libpath1f80289460a6/testRapi/java/r6-generator-maven-plugin-test-master-SNAPSHOT-jar-with-dependencies.jar</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">J</span><span class="op">$</span><span class="fu">changeLogLevel</span><span class="op">(</span><span class="st">"DEBUG"</span><span class="op">)</span>
<span class="va">J</span><span class="op">$</span><span class="va">.log</span><span class="op">$</span><span class="fu">debug</span><span class="op">(</span><span class="st">"prove the logger is working and outputting debug statements..."</span><span class="op">)</span>
<span class="va">J</span><span class="op">$</span><span class="fu">printMessages</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## 2021-12-27 18:18:02,729 DEBUG testRapi [main] prove the logger is working and outputting debug statements...</span></code></pre>
<p>Using the <code>FeatureTest</code> class above requires a creating a new instance of the class. This is done through the root of the api as follows, and the <code>FeatureTest</code> constructor simply logs the <code>logMessage</code> parameter’s value.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">feat1</span> <span class="op">=</span> <span class="va">J</span><span class="op">$</span><span class="va">FeatureTest</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>logMessage <span class="op">=</span> <span class="st">"Hello world. Creating a new object"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## 2021-12-27 18:18:02,746 INFO uk.co.terminological.rjava.test.FeatureTest [main] Hello world. Creating a new object</span></code></pre>
</div>
<div class="section level2">
<h2 id="predictable-data-type-conversion">Predictable data type conversion<a class="anchor" aria-label="anchor" href="#predictable-data-type-conversion"></a>
</h2>
<div class="sourceCode"><pre class="sourceCode java"><code class="sourceCode java">    
    <span class="co">/**</span>
     <span class="co">*</span> Description of a hello world function
     <span class="co">* </span><span class="kw">@return </span>this java method returns a String
     <span class="co">*/</span>
    <span class="at">@RMethod</span>(examples = {
            <span class="st">"minExample = J$FeatureTest$new('Hello, R World!')"</span>,
            <span class="st">"minExample$doHelloWorld()"</span>
        })
    <span class="kw">public</span> RCharacter <span class="fu">doHelloWorld</span>() {
        <span class="kw">return</span> RConverter.<span class="fu">convert</span>(<span class="st">"Hello world from Java!"</span>);
    }
        
    <span class="co">/**</span>
     <span class="co">*</span> The doSum function description <span class="co">=</span> it adds two numerics
     <span class="co">* </span><span class="kw">@param a </span>the A parameter<span class="co">,</span> can be NA
     <span class="co">*</span> <span class="kw">@param b </span>the B parameter
     <span class="co">*</span> <span class="kw">@return </span>A<span class="co">+</span>B of course<span class="co">,</span> NAs in inputs are converted to null in Java<span class="co">.</span> This catches the resulting NPE in java idiom and returns an explicit NA<span class="co">.</span> 
     <span class="co">*</span> This only matters if you care about the difference between NA_real_ and NaN in R<span class="co">.</span> 
     <span class="co">*/</span>
    <span class="at">@RMethod</span>
    <span class="kw">public</span> RNumeric <span class="fu">doSum</span>(RNumeric a, RNumeric b) {
        <span class="kw">try</span> {
            <span class="kw">return</span> RConverter.<span class="fu">convert</span>(a.<span class="fu">get</span>()+b.<span class="fu">get</span>());
        } <span class="kw">catch</span> (<span class="bu">NullPointerException</span> e) {
            log.<span class="fu">info</span>(<span class="st">"Java threw a NPE - could have had a NA input?"</span>);
            <span class="kw">return</span> RNumeric.<span class="fu">NA</span>;
        }
    }
    
    
    <span class="co">/**</span>
     <span class="co">*</span> Do sum <span class="co">2</span> uses native ints rather than RNumerics
     <span class="co">*</span> It should throw an error if given something that cannot be coerced to an integer 
     <span class="co">* </span><span class="kw">@param a </span>the A parameter
     <span class="co">*</span> <span class="kw">@param b </span>the B parameter
     <span class="co">*</span> <span class="kw">@return </span>A<span class="co">+</span>B of course
     <span class="co">*/</span>
    <span class="at">@RMethod</span>
    <span class="kw">public</span> <span class="dt">int</span> <span class="fu">doSum2</span>(<span class="dt">int</span> a, <span class="dt">int</span> b) {
        <span class="kw">return</span> a+b;
    }
    
    <span class="co">/**</span>
     <span class="co">*</span> Static methods are also supported<span class="co">. </span>These are accessed through the
     <span class="co">*</span> root of the R api<span class="co">.</span>
     <span class="co">*</span> <span class="kw">@param message </span>a message
     <span class="co">*/</span>
    <span class="at">@RMethod</span>(examples = {
            <span class="st">"J$FeatureTest$demoStatic('Ola, el mundo')"</span>,
    })
    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">demoStatic</span>(<span class="bu">String</span> message) {
        log.<span class="fu">info</span>(message);
    }
    </code></pre></div>
<p>The <code>FeatureClass.doHelloWorld()</code> method takes no arguments and returns a value to R. A detailed discussion of R and Java data types is to be found elsewhere but our approach has involved developing a specific set of Java datatypes that have close relationships to the native R datatypes. This enables loss-less round tripping of data from R to Java and back again, but requires the mapping of Java data types to R. This is handled by the <code>uk.co.terminological.rjava.RConverter</code> class which provides a range of datatype transformers, and the <code>uk.co.terminological.rjava.types.*</code> classes which specify Java equivalents to R data types. These are needed as R’s dynamic datatypes contain concepts which are not readily represented in the primitive java datatypes that are transferred across the JNI. Thus some marshaling is required on both sides to ensure translation is 100% accurate, including for example, conversion of R logical vectors containing NA values, to java <code>List&lt;Boolean&gt;</code> via JNI primitive arrays, or support for typed NA values (e.g. <code>NA_int_</code> versus <code>NA_logical_</code>).</p>
<p>The <code>doHelloWorld()</code> function returns a character vector, The <code>doSum()</code> function expects 2 R numeric values and seamlessly handles both datatype coercion and NA values.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">feat1</span><span class="op">$</span><span class="fu">doHelloWorld</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "Hello world from Java!"</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">doHelloWorld</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "character"</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">feat1</span><span class="op">$</span><span class="fu">doSum</span><span class="op">(</span><span class="fl">3L</span>, <span class="fl">4.1</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 7.1</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">doSum</span><span class="op">(</span><span class="fl">3L</span>, <span class="fl">4.1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "numeric"</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">feat1</span><span class="op">$</span><span class="fu">doSum</span><span class="op">(</span><span class="fl">3.0</span>, <span class="cn">NA_real_</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## 2021-12-27 18:18:02,784 INFO uk.co.terminological.rjava.test.FeatureTest [main] Java threw a NPE - could have had a NA input?</span></code></pre>
<pre><code><span class="co">## [1] NA</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">doSum</span><span class="op">(</span><span class="fl">3.0</span>, <span class="cn">NA_real_</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## 2021-12-27 18:18:02,787 INFO uk.co.terminological.rjava.test.FeatureTest [main] Java threw a NPE - could have had a NA input?</span></code></pre>
<pre><code><span class="co">## [1] "numeric"</span></code></pre>
<p>Wrapping and unwrapping every datatype is inconvenient for the Java programmer so some single valued primitive types are supported as parameters and return types of Java functions, particularly <code>int</code>, <code>char</code>, <code>double</code>, <code>boolean</code>, and <code>java.lang.String</code>, but these come with constraints on use, particularly around NA values in R.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">feat1</span><span class="op">$</span><span class="fu">doSum2</span><span class="op">(</span><span class="fl">3L</span>, <span class="fl">4L</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 7</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">doSum2</span><span class="op">(</span><span class="fl">3L</span>, <span class="fl">4L</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "integer"</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># casts inputs to integer</span>
<span class="va">feat1</span><span class="op">$</span><span class="fu">doSum2</span><span class="op">(</span><span class="fl">3.0</span>,<span class="fl">4.0</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] 7</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">doSum2</span><span class="op">(</span><span class="fl">3.0</span>,<span class="fl">4.0</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "integer"</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># fails as expects an integer</span>
<span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">doSum2</span><span class="op">(</span><span class="fl">3.0</span>,<span class="fl">4.5</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Error in self$.api$.toJava$int(b) : not an integer</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># fails as NA values are not supported by primitive types</span>
<span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">doSum2</span><span class="op">(</span><span class="fl">3L</span>,<span class="cn">NA_integer_</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Error in self$.api$.toJava$int(b) : cant use NA as input to java int</span></code></pre>
<p>Static java methods are also supported. R6 does not have a concept of static methods, so we use the root of the JavaApi as a place to hold the static methods, which in this case returns nothing (an R NULL is invisibly returned), but logs its input.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">J</span><span class="op">$</span><span class="va">FeatureTest</span><span class="op">$</span><span class="fu">demoStatic</span><span class="op">(</span><span class="st">"Hello, static world."</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## 2021-12-27 18:18:02,815 INFO uk.co.terminological.rjava.test.FeatureTest [main] Hello, static world.</span></code></pre>
</div>
<div class="section level2">
<h2 id="more-complex-objects">More complex objects<a class="anchor" aria-label="anchor" href="#more-complex-objects"></a>
</h2>
<p>The generated API has support for the loss-less bi-directional transfer of a range of R data types into Java and back to R. Extensive tests are available elsewhere but in general support for vectors, dataframes and lists is mostly complete, including factors, but matrices and arrays are not yet implemented. Dataframes with named rows are also not yet supported. Dataframes as well as other objects can be serialised in Java and de-serialised. This serialisation has been done for the ggplot2::diamonds data set, and the resulting de-serialisation shown here. Factor levels and ordering are preserved when the factor is part of a vector or dataframe.</p>
<div class="sourceCode"><pre class="sourceCode java"><code class="sourceCode java">    
    <span class="co">/**</span>
     <span class="co">*</span> Consumes a data frame and logs its length
     <span class="co">* </span><span class="kw">@param dataframe </span>a dataframe
     <span class="co">*/</span>
    <span class="at">@RMethod</span>
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">doSomethingWithDataFrame</span>(RDataframe dataframe) {
        log.<span class="fu">info</span>(<span class="st">"dataframe length: "</span>+dataframe.<span class="fu">nrow</span>());
    }
    
    <span class="co">/**</span>
     <span class="co">*</span> Creates a basic dataframe and returns it
     <span class="co">* </span><span class="kw">@return </span>a daatframe
     <span class="co">*/</span>
    <span class="at">@RMethod</span>
    <span class="kw">public</span> RDataframe <span class="fu">generateDataFrame</span>() {
        RDataframe out = <span class="kw">new</span> <span class="fu">RDataframe</span>();
        <span class="kw">for</span> (<span class="dt">int</span> i=<span class="dv">0</span>; i&lt;<span class="dv">10</span>; i++) {
            <span class="bu">Map</span>&lt;<span class="bu">String</span>,<span class="bu">Object</span>&gt; tmp = <span class="kw">new</span> <span class="bu">LinkedHashMap</span>&lt;<span class="bu">String</span>,<span class="bu">Object</span>&gt;();
            tmp.<span class="fu">put</span>(<span class="st">"index"</span>, i);
            tmp.<span class="fu">put</span>(<span class="st">"value"</span>, <span class="dv">10</span>-i);
            out.<span class="fu">addRow</span>(tmp);
        }
        <span class="kw">return</span> out;
        
    }
    
    <span class="co">/**</span>
     <span class="co">*</span> A copy of the ggplot2<span class="co">::</span>diamonds dataframe serialised into java<span class="co">,</span> using
     <span class="co">*</span> RObject<span class="co">.</span>writeRDS<span class="co">,</span> saved within the jar file of the package<span class="co">,</span> and exposed here
     <span class="co">*</span> using RObject<span class="co">.</span>readRDS<span class="co">. </span>
     <span class="co">*</span> <span class="kw">@return </span>the ggplot2<span class="co">::</span>diamonds dataframe
     <span class="co">*</span> <span class="kw">@throws IOException </span>if the serialised data file could not be found 
     <span class="co">*/</span>
    <span class="at">@RMethod</span>(examples = {
            <span class="st">"J$FeatureTest$diamonds()"</span>,
    })
    <span class="kw">public</span> <span class="dt">static</span> RDataframe <span class="fu">diamonds</span>() <span class="kw">throws</span> <span class="bu">IOException</span> {
        <span class="bu">InputStream</span> is = FeatureTest.<span class="fu">class</span>.<span class="fu">getResourceAsStream</span>(<span class="st">"/diamonds.ser"</span>);
        <span class="kw">if</span>(is==<span class="kw">null</span>) <span class="kw">throw</span> <span class="kw">new</span> <span class="bu">IOException</span>(<span class="st">"Could not locate /diamonds.ser"</span>);
        <span class="kw">return</span> RObject.<span class="fu">readRDS</span>(RDataframe.<span class="fu">class</span>, is);
    }
    </code></pre></div>
<p>The basic smoke tests of this are as follows</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">feat1</span><span class="op">$</span><span class="fu">doSomethingWithDataFrame</span><span class="op">(</span><span class="fu">ggplot2</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/ggplot2/man/diamonds.html" class="external-link">diamonds</a></span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## 2021-12-27 18:18:02,926 INFO uk.co.terminological.rjava.test.FeatureTest [main] dataframe length: 53940</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">feat1</span><span class="op">$</span><span class="fu">generateDataFrame</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">glimpse</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Rows: 10</span>
<span class="co">## Columns: 2</span>
<span class="co">## $ index <span style="color: #949494;font-style: italic;">&lt;int&gt;</span><span> 0, 1, 2, 3, 4, 5, 6, 7, 8, 9</span></span>
<span class="co">## $ value <span style="color: #949494;font-style: italic;">&lt;int&gt;</span><span> 10, 9, 8, 7, 6, 5, 4, 3, 2, 1</span></span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">J</span><span class="op">$</span><span class="va">FeatureTest</span><span class="op">$</span><span class="fu">diamonds</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">glimpse</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Rows: 53,940</span>
<span class="co">## Columns: 10</span>
<span class="co">## $ carat   <span style="color: #949494;font-style: italic;">&lt;dbl&gt;</span><span> 0.23, 0.21, 0.23, 0.29, 0.31, 0.24, 0.24, 0.26, 0.22, 0.23, 0.…</span></span>
<span class="co">## $ cut     <span style="color: #949494;font-style: italic;">&lt;ord&gt;</span><span> Ideal, Premium, Good, Premium, Good, Very Good, Very Good, Ver…</span></span>
<span class="co">## $ color   <span style="color: #949494;font-style: italic;">&lt;ord&gt;</span><span> E, E, E, I, J, J, I, H, E, H, J, J, F, J, E, E, I, J, J, J, I,…</span></span>
<span class="co">## $ clarity <span style="color: #949494;font-style: italic;">&lt;ord&gt;</span><span> SI2, SI1, VS1, VS2, SI2, VVS2, VVS1, SI1, VS2, VS1, SI1, VS1, …</span></span>
<span class="co">## $ depth   <span style="color: #949494;font-style: italic;">&lt;dbl&gt;</span><span> 61.5, 59.8, 56.9, 62.4, 63.3, 62.8, 62.3, 61.9, 65.1, 59.4, 64…</span></span>
<span class="co">## $ table   <span style="color: #949494;font-style: italic;">&lt;dbl&gt;</span><span> 55, 61, 65, 58, 58, 57, 57, 55, 61, 61, 55, 56, 61, 54, 62, 58…</span></span>
<span class="co">## $ price   <span style="color: #949494;font-style: italic;">&lt;int&gt;</span><span> 326, 326, 327, 334, 335, 336, 336, 337, 337, 338, 339, 340, 34…</span></span>
<span class="co">## $ x       <span style="color: #949494;font-style: italic;">&lt;dbl&gt;</span><span> 3.95, 3.89, 4.05, 4.20, 4.34, 3.94, 3.95, 4.07, 3.87, 4.00, 4.…</span></span>
<span class="co">## $ y       <span style="color: #949494;font-style: italic;">&lt;dbl&gt;</span><span> 3.98, 3.84, 4.07, 4.23, 4.35, 3.96, 3.98, 4.11, 3.78, 4.05, 4.…</span></span>
<span class="co">## $ z       <span style="color: #949494;font-style: italic;">&lt;dbl&gt;</span><span> 2.43, 2.31, 2.31, 2.63, 2.75, 2.48, 2.47, 2.53, 2.49, 2.39, 2.…</span></span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">J</span><span class="op">$</span><span class="va">FeatureTest</span><span class="op">$</span><span class="fu">diamonds</span><span class="op">(</span><span class="op">)</span>, <span class="fu">ggplot2</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/ggplot2/man/diamonds.html" class="external-link">diamonds</a></span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"PASS: round tripping ggplot2::diamonds including java serialisation and deserialisation works"</span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"FAIL: serialised diamonds from Java should be identical to the ggplot source"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<pre><code><span class="co">## PASS: round tripping ggplot2::diamonds including java serialisation and deserialisation works</span></code></pre>
</div>
<div class="section level2">
<h2 id="objects-fluent-apis-and-factory-methods">Objects, fluent apis and factory methods<a class="anchor" aria-label="anchor" href="#objects-fluent-apis-and-factory-methods"></a>
</h2>
<p>The generated R6 code can handle return of Java objects to R, as long as they are a part of the api and annotated with <code>@RClass</code>. A common use case for this is fluent Apis, where the Java object is manipulated by a method and returns itself.</p>
<div class="sourceCode"><pre class="sourceCode java"><code class="sourceCode java">    
    <span class="co">/**</span>
     <span class="co">*</span> message desciption
     <span class="co">* </span><span class="kw">@return </span>The message <span class="co">(</span>previously set by the constructor<span class="co">)</span>
     <span class="co">*/</span>
    <span class="at">@RMethod</span>
    <span class="kw">public</span> RCharacter <span class="fu">getMessage</span>() {
        <span class="kw">return</span> RConverter.<span class="fu">convert</span>(message);
    }   
    
    <span class="co">/**</span>
     <span class="co">*</span> A fluent method which updates the message in this object<span class="co">,</span> returning the
     <span class="co">*</span> same object<span class="co">. </span>This is differentiated from factory methods which produce a new
     <span class="co">*</span> instance of the same class by checking to see if the returned Java object is equal
     <span class="co">*</span> to the calling Java object<span class="co">.</span>  
     <span class="co">*</span> <span class="kw">@param message </span>the message is a string
     <span class="co">*</span> <span class="kw">@return </span>this should return exactly the same R6 object<span class="co">.</span>
     <span class="co">*/</span>
    <span class="at">@RMethod</span>
    <span class="kw">public</span> FeatureTest <span class="fu">fluentSetMessage</span>(RCharacter message) {
        <span class="kw">this</span>.<span class="fu">message</span> = message.<span class="fu">toString</span>();
        <span class="kw">return</span> <span class="kw">this</span>;
    }
    </code></pre></div>
<p>The <code>JavaApi</code> root manages R’s perspective on the identity of objects in Java. This allows for fluent api methods, and method chaining. This is not flawless but should work for most common scenarios. It is possible that complex edge cases may appear equal in Java but not identical in R, so true equality should rely on the Java <code>equals()</code> method.</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">feat1</span><span class="op">$</span><span class="fu">getMessage</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "Hello world. Creating a new object"</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">feat2</span> <span class="op">=</span> <span class="va">feat1</span><span class="op">$</span><span class="fu">fluentSetMessage</span><span class="op">(</span><span class="st">"Hello world. updating message."</span><span class="op">)</span>
<span class="va">feat2</span><span class="op">$</span><span class="fu">getMessage</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "Hello world. updating message."</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">feat1</span>,<span class="va">feat2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"PASS: the return value of a fluent setter returns the same object as the original"</span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="va">.jobj</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">feat2</span><span class="op">$</span><span class="va">.jobj</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="va">.jobj</span><span class="op">$</span><span class="fu">equals</span><span class="op">(</span><span class="va">feat2</span><span class="op">$</span><span class="va">.jobj</span><span class="op">)</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"FAIL: these should have been identical"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<pre><code><span class="co">## PASS: the return value of a fluent setter returns the same object as the original</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="va">feat1</span><span class="op">$</span><span class="fu">equals</span><span class="op">(</span><span class="va">feat2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"PASS: java based equality detection is supported"</span><span class="op">)</span>
<span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"FAIL: these should have been equal"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<pre><code><span class="co">## PASS: java based equality detection is supported</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">feat1</span><span class="op">$</span><span class="fu">getMessage</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "Hello world. updating message."</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Operations on feat2 are occurring on feat1 as they are the same underlying object</span>
<span class="va">feat2</span><span class="op">$</span><span class="fu">fluentSetMessage</span><span class="op">(</span><span class="st">"Hello world. updating message again."</span><span class="op">)</span>
<span class="va">feat1</span><span class="op">$</span><span class="fu">getMessage</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "Hello world. updating message again."</span></code></pre>
<p>Factory methods allow java methods to create and return Java objects. This is supported as long as the objects are a part of the api and annotated with <code>@RClass</code>. Arbitrary java objects are not supported as return types and java code that tries to return such objects will throw an exception during the maven packaging phase. This is by design to enforce formal contracts between the Java code and the R api. If you want dynamic manipulation of the Java objects then the <em>jsr223</em> plugin is more appropriate for you.</p>
<div class="sourceCode"><pre class="sourceCode java"><code class="sourceCode java">    
    <span class="co">/**</span>
     <span class="co">*</span> A factory or builder method which constructs an object of another class from some parameters 
     <span class="co">* </span><span class="kw">@param a </span>the first parameter
     <span class="co">*</span> <span class="kw">@param b </span>the second parameter
     <span class="co">*</span> <span class="kw">@return </span>A MoreFeatureTest R6 reference
     <span class="co">*/</span>
    <span class="at">@RMethod</span>
    <span class="kw">public</span> MoreFeatureTest <span class="fu">factoryMethod</span>(RCharacter a, RCharacter b) {
        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">MoreFeatureTest</span>(a,b);
    }
    
    <span class="at">@RMethod</span>
    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">objectAsParameter</span>(MoreFeatureTest otherObj) {
        <span class="kw">return</span> otherObj.<span class="fu">toString</span>();
    }</code></pre></div>
<p>This java code from refers to another class - <code>MoreFeatureTest</code> which has the following basic structure:</p>
<div class="sourceCode"><pre class="sourceCode java"><code class="sourceCode java"><span class="co">/**</span>
 <span class="co">*</span> This has no documentation
 <span class="co">*/</span>
<span class="at">@RClass</span>
<span class="kw">public</span> <span class="kw">class</span> MoreFeatureTest {

    <span class="bu">String</span> message1;
    <span class="bu">String</span> message2;
    
    <span class="dt">static</span> <span class="bu">Logger</span> log = LoggerFactory.<span class="fu">getLogger</span>(MoreFeatureTest.<span class="fu">class</span>); 
    
    <span class="co">/**</span>
     <span class="co">*</span> the first constructor is used if there are none annotated 
     <span class="co">* </span><span class="kw">@param message1 </span><span class="co">-</span> the message to be printed 
     <span class="co">*</span> <span class="kw">@param message2 </span><span class="co">-</span> will be used for toString
     <span class="co">*/</span>
    <span class="kw">public</span> <span class="fu">MoreFeatureTest</span>(RCharacter message1, RCharacter message2) {
        <span class="kw">this</span>.<span class="fu">message1</span> = message1.<span class="fu">toString</span>();
        <span class="kw">this</span>.<span class="fu">message2</span> = message2.<span class="fu">toString</span>();
        log.<span class="fu">info</span>(<span class="st">"constuctor: {}, {}"</span>,<span class="kw">this</span>.<span class="fu">message1</span>, <span class="kw">this</span>.<span class="fu">message2</span>);
    }
    
    <span class="co">/**</span> A static object constructor
     <span class="co">* </span><span class="kw">@param message1 </span><span class="co">-</span> the message to be printed 
     <span class="co">*</span> <span class="kw">@param message2 </span><span class="co">-</span> will be used for toString
     <span class="co">*</span> <span class="kw">@return </span>A MoreFeatureTest R6 object
     <span class="co">*/</span>
    <span class="at">@RMethod</span>(examples = {
        <span class="st">"J$MoreFeatureTest$create('Hello,',' World')"</span>,
    })
    <span class="kw">public</span> <span class="dt">static</span> MoreFeatureTest <span class="fu">create</span>(RCharacter message1, RCharacter message2) {
        <span class="kw">return</span> <span class="kw">new</span> <span class="fu">MoreFeatureTest</span>(message1,message2);
    }
    
...
}</code></pre></div>
<p>The <code>FeatureTest.factoryMethod(a,b)</code> method allows us to construct instances of another class. This enables builder patterns in the R api. The <code>MoreFeatureTest.create(message1,message2)</code> method demonstrates static factory methods, which return instances of the same class. Static methods are implemented as methods in the <code>JavaApi</code> root, as demonstrated here, and accessed through the root object <code>J</code>:</p>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># factory method from builder class</span>
<span class="va">moreFeat1</span> <span class="op">=</span> <span class="va">feat1</span><span class="op">$</span><span class="fu">factoryMethod</span><span class="op">(</span><span class="st">"Hello"</span>,<span class="st">"World"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## 2021-12-27 18:18:05,857 INFO uk.co.terminological.rjava.test.MoreFeatureTest [main] constuctor: Hello, World</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># static factory method accessed through the root of the API</span>
<span class="va">moreFeat2</span> <span class="op">=</span> <span class="va">J</span><span class="op">$</span><span class="va">MoreFeatureTest</span><span class="op">$</span><span class="fu">create</span><span class="op">(</span><span class="st">"Ola"</span>,<span class="st">"El Mundo"</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## 2021-12-27 18:18:05,864 INFO uk.co.terminological.rjava.test.MoreFeatureTest [main] constuctor: Ola, El Mundo</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># either of these can be passed as a parameter</span>
<span class="va">feat1</span><span class="op">$</span><span class="fu">objectAsParameter</span><span class="op">(</span><span class="va">moreFeat1</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "toString: World"</span></code></pre>
</div>
<div class="section level2">
<h2 id="logging-printing-and-exceptions">Logging, printing and exceptions<a class="anchor" aria-label="anchor" href="#logging-printing-and-exceptions"></a>
</h2>
<p>The logging sub-system is based on <code>slf4j</code> with a <code>log4j2</code> implementation. These are specified in the <code>r6-generator-runtime</code> dependency pom, so anything that imports that will have them as a transitive dependency. These are needed as dynamic alteration of the logging level from R is dependent on implementation details of <code>log4j</code>. This is maybe possible to remove in the future.</p>
<p>Exceptions thrown from Java are handled in the same way as <em>rJava</em>, and printed messages are seen on the R console as expected. However rJava does something strange to messages from <code>System.out</code> that means they do not appear in knitr output. To resolve this a unsightly workaround (hack) has been adopted that collects messages from system out and prints them after the Java method has completed. This has the potential to cause all sorts of issues.</p>
<p>The logging level can be controlled at runtime by a function in the <code>JavaApi</code> root. Logging can be configured dynamically with a <code>log4j</code> properties file (not shown) to enable file based logging, for example.</p>
<div class="sourceCode"><pre class="sourceCode java"><code class="sourceCode java">    
    <span class="at">@RMethod</span> 
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">testLogging</span>() {
        log.<span class="fu">error</span>(<span class="st">"An error"</span>);
        log.<span class="fu">warn</span>(<span class="st">"A warning"</span>);
        log.<span class="fu">info</span>(<span class="st">"A info"</span>);
        log.<span class="fu">debug</span>(<span class="st">"A debug"</span>);
        log.<span class="fu">trace</span>(<span class="st">"A trace"</span>);
    }
            
    <span class="at">@RMethod</span>
    <span class="kw">public</span> RCharacter <span class="fu">throwCatchable</span>() <span class="kw">throws</span> <span class="bu">Exception</span> {
        <span class="kw">throw</span> <span class="kw">new</span> <span class="bu">Exception</span>(<span class="st">"A catchable exception has been thrown"</span>);
    }
    
    <span class="at">@RMethod</span>
    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">printMessage</span>() {
        <span class="bu">System</span>.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">"Printed in java: "</span>+message1+<span class="st">" "</span>+message2);
    }
    
    <span class="at">@RMethod</span>
    <span class="kw">public</span> RCharacter <span class="fu">throwRuntime</span>() {
        <span class="kw">throw</span> <span class="kw">new</span> <span class="bu">RuntimeException</span>(<span class="st">"A runtime exception has been thrown"</span>);
    }
    
    <span class="kw">public</span> <span class="bu">String</span> <span class="fu">toString</span>() {
        <span class="kw">return</span> <span class="st">"toString: "</span>+message2;
    }</code></pre></div>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># </span>
<span class="co"># System.out printing</span>
<span class="va">moreFeat1</span><span class="op">$</span><span class="fu">printMessage</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Printed in java: Hello World</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Testing logging levels</span>
<span class="va">J</span><span class="op">$</span><span class="fu">changeLogLevel</span><span class="op">(</span><span class="st">"ALL"</span><span class="op">)</span>
<span class="va">moreFeat1</span><span class="op">$</span><span class="fu">testLogging</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## 2021-12-27 18:18:05,888 ERROR uk.co.terminological.rjava.test.MoreFeatureTest [main] An error</span>
<span class="co">## 2021-12-27 18:18:05,888 WARN uk.co.terminological.rjava.test.MoreFeatureTest [main] A warning</span>
<span class="co">## 2021-12-27 18:18:05,888 INFO uk.co.terminological.rjava.test.MoreFeatureTest [main] A info</span>
<span class="co">## 2021-12-27 18:18:05,888 DEBUG uk.co.terminological.rjava.test.MoreFeatureTest [main] A debug</span>
<span class="co">## 2021-12-27 18:18:05,888 TRACE uk.co.terminological.rjava.test.MoreFeatureTest [main] A trace</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="va">moreFeat1</span><span class="op">$</span><span class="fu">throwCatchable</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Error in .jcall(self$.jobj, returnSig = "Luk/co/terminological/rjava/types/RCharacter;",  : </span>
<span class="co">##   java.lang.Exception: A catchable exception has been thrown</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="va">moreFeat1</span><span class="op">$</span><span class="fu">throwRuntime</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Error in .jcall(self$.jobj, returnSig = "Luk/co/terminological/rjava/types/RCharacter;",  : </span>
<span class="co">##   java.lang.RuntimeException: A runtime exception has been thrown</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">J</span><span class="op">$</span><span class="fu">changeLogLevel</span><span class="op">(</span><span class="st">"ERROR"</span><span class="op">)</span>
<span class="va">moreFeat1</span><span class="op">$</span><span class="fu">testLogging</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## 2021-12-27 18:18:05,895 ERROR uk.co.terminological.rjava.test.MoreFeatureTest [main] An error</span></code></pre>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># J$reconfigureLog("/path/to/log4j.prop")</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="support-for-debugging">Support for debugging<a class="anchor" aria-label="anchor" href="#support-for-debugging"></a>
</h2>
<p>Debugging compiled java code running in the context of a R is not for the faint-hearted. It definitely makes sense to test and debug the java code in Java first. To make this possible it is useful to be able to serialise some test data in the exact format in which it will arrive in Java from R. To that end all the Java structures supported can be serialised, and de-serialised for testing purposes. The <code>testRapi</code> library presented here has a set of functions that facilitate this as static methods of <code>J$Serialiser</code>.</p>
<div class="sourceCode"><pre class="sourceCode java"><code class="sourceCode java">    
    <span class="at">@RMethod</span>
    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">serialiseDataframe</span>(RDataframe dataframe, <span class="bu">String</span> filename) <span class="kw">throws</span> <span class="bu">IOException</span> {
        <span class="bu">FileOutputStream</span> fos = <span class="kw">new</span> <span class="bu">FileOutputStream</span>(filename);
        dataframe.<span class="fu">writeRDS</span>(fos);
        log.<span class="fu">info</span>(<span class="st">"dataframe written to: "</span>+filename);
    }
    
    <span class="at">@RMethod</span>
    <span class="kw">public</span> <span class="dt">static</span> RDataframe <span class="fu">deserialiseDataframe</span>(<span class="bu">String</span> filename) <span class="kw">throws</span> <span class="bu">IOException</span> {
        <span class="bu">InputStream</span> is = Files.<span class="fu">newInputStream</span>(Paths.<span class="fu">get</span>(filename));
        <span class="kw">if</span>(is==<span class="kw">null</span>) <span class="kw">throw</span> <span class="kw">new</span> <span class="bu">IOException</span>(<span class="st">"Could not locate "</span>+filename);
        <span class="kw">return</span> RObject.<span class="fu">readRDS</span>(RDataframe.<span class="fu">class</span>, is);
    }
    </code></pre></div>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"diamonds"</span>, fileext <span class="op">=</span> <span class="st">".ser"</span><span class="op">)</span>
<span class="va">J</span><span class="op">$</span><span class="va">Serialiser</span><span class="op">$</span><span class="fu">serialiseDataframe</span><span class="op">(</span>dataframe <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/ggplot2/man/diamonds.html" class="external-link">diamonds</a></span>, filename <span class="op">=</span> <span class="va">s</span><span class="op">)</span>
<span class="va">J</span><span class="op">$</span><span class="va">Serialiser</span><span class="op">$</span><span class="fu">deserialiseDataframe</span><span class="op">(</span>filename<span class="op">=</span><span class="va">s</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">glimpse</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Rows: 53,940</span>
<span class="co">## Columns: 10</span>
<span class="co">## $ carat   <span style="color: #949494;font-style: italic;">&lt;dbl&gt;</span><span> 0.23, 0.21, 0.23, 0.29, 0.31, 0.24, 0.24, 0.26, 0.22, 0.23, 0.…</span></span>
<span class="co">## $ cut     <span style="color: #949494;font-style: italic;">&lt;ord&gt;</span><span> Ideal, Premium, Good, Premium, Good, Very Good, Very Good, Ver…</span></span>
<span class="co">## $ color   <span style="color: #949494;font-style: italic;">&lt;ord&gt;</span><span> E, E, E, I, J, J, I, H, E, H, J, J, F, J, E, E, I, J, J, J, I,…</span></span>
<span class="co">## $ clarity <span style="color: #949494;font-style: italic;">&lt;ord&gt;</span><span> SI2, SI1, VS1, VS2, SI2, VVS2, VVS1, SI1, VS2, VS1, SI1, VS1, …</span></span>
<span class="co">## $ depth   <span style="color: #949494;font-style: italic;">&lt;dbl&gt;</span><span> 61.5, 59.8, 56.9, 62.4, 63.3, 62.8, 62.3, 61.9, 65.1, 59.4, 64…</span></span>
<span class="co">## $ table   <span style="color: #949494;font-style: italic;">&lt;dbl&gt;</span><span> 55, 61, 65, 58, 58, 57, 57, 55, 61, 61, 55, 56, 61, 54, 62, 58…</span></span>
<span class="co">## $ price   <span style="color: #949494;font-style: italic;">&lt;int&gt;</span><span> 326, 326, 327, 334, 335, 336, 336, 337, 337, 338, 339, 340, 34…</span></span>
<span class="co">## $ x       <span style="color: #949494;font-style: italic;">&lt;dbl&gt;</span><span> 3.95, 3.89, 4.05, 4.20, 4.34, 3.94, 3.95, 4.07, 3.87, 4.00, 4.…</span></span>
<span class="co">## $ y       <span style="color: #949494;font-style: italic;">&lt;dbl&gt;</span><span> 3.98, 3.84, 4.07, 4.23, 4.35, 3.96, 3.98, 4.11, 3.78, 4.05, 4.…</span></span>
<span class="co">## $ z       <span style="color: #949494;font-style: italic;">&lt;dbl&gt;</span><span> 2.43, 2.31, 2.31, 2.63, 2.75, 2.48, 2.47, 2.53, 2.49, 2.39, 2.…</span></span></code></pre>
<p>With serialised test data, as dataframes, lists or named lists, development of java functions and unit tests can be created that output values of the correct <code>RObject</code> datatype. Correct packaging and integration with R is a question of running <code>mvn install</code> to compile the Java into a jar file and generate R library code, then using <code><a href="https://rdrr.io/pkg/devtools/man/install.html" class="external-link">devtools::install</a></code> to install the generated R library.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="co"># compile Java code and package R library using `mvn install` command</span>
<span class="bu">cd</span> ~/Git/r6-generator-maven-plugin-test
<span class="ex">mvn</span> install</code></pre></div>
<div class="sourceCode"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">setwd</a></span><span class="op">(</span><span class="st">"~/Git/r6-generator-maven-plugin-test"</span><span class="op">)</span>
<span class="co"># remove previously installed versions</span>
<span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/detach.html" class="external-link">detach</a></span><span class="op">(</span><span class="st">"package:testRapi"</span>, unload <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/remove.packages.html" class="external-link">remove.packages</a></span><span class="op">(</span><span class="st">"testRapi"</span><span class="op">)</span>
<span class="co"># rm(list = ls()) may be required to clear old versions of the library code</span>
<span class="co"># Restarting R maybe also required if there was a running java VM otherwise changes to the jars on the classpath are not picked up.</span>
<span class="co"># install locally compiled R library:</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/devtools/man/install.html" class="external-link">install</a></span><span class="op">(</span><span class="st">"~/Git/r6-generator-maven-plugin-test/r-library/"</span>, upgrade <span class="op">=</span> <span class="st">"never"</span><span class="op">)</span>
<span class="co"># N.B. devtools::load_all() does not appear to always successfully pick up changes in the compiled java code</span></code></pre></div>
<p>For initial integration testing there is a debug flag in the maven <code>pom.xml</code> that enables remote java debugging to the initialized when the library is first loaded in R. When set to true a java debugging session on port 8998 is opened which can be connected to as a remote java application. This allows breakpoints to be set on Java code and the state of the JVM to be inspected when Java code is executed from R, however Java code changes cannot be hot-swapped into the running JVM, and so debugging integration issues is relatively limited. For more details see the <a href="./R6-generator-maven-config">Maven configuration vignette</a>.</p>
<p>There are other limitations with enabling java debugging, not least being the potential for port conflicts with multiple running instances of the development library, and caching issues between running and loaded versions of the Java code. Whilst not too painful (compared to the alternatives) this is very definitely not a REPL experience and reserved for the last stage of debugging. Part of the purpose of strongly enforcing a datatype conversion contract between Java and R, and extensive use of code generation, is to decouple Java and R development as much as possible (N.B. do as I say - not as I do).</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Rob Challen, terminological, given family.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
